---------------------
index.html å†…å®¹å¦‚ä¸‹
--------------------
<!-- æ·±è‰²ä¸»é¢˜ index.html -->
<!doctype html>
<html lang="zh-CN" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>åˆ†é•œç‹®</title>
        <link
            rel="icon"
            type="image/png"
            href="{{ url_for('static', filename='favicon-96x96.png') }}"
            sizes="96x96"
        />
        <link
            rel="icon"
            type="image/svg+xml"
            href="{{ url_for('static', filename='favicon.svg') }}"
        />
        <link
            rel="shortcut icon"
            href="{{ url_for('static', filename='favicon.ico') }}"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ url_for('static', filename='apple-touch-icon.png') }}"
        />
        <link
            rel="manifest"
            href="{{ url_for('static', filename='site.webmanifest') }}"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', filename='main.css') }}"
            rel="stylesheet"
        />
    </head>
    <body>
        <!-- å·¥å…·ä¾§è¾¹æ ï¼ˆå‚ç›´å°å›¾æ ‡ï¼‰ -->
        <div id="toolSidebar" class="tool-sidebar">
            <button
                class="btn btn-dark tool-btn"
                type="button"
                title="å¿«æ·è®¿é—®"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                data-target="quick-access"
            >
                â˜…
            </button>
            <button
                class="btn btn-dark tool-btn"
                type="button"
                title="å†å²è®°å½•"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                data-target="history-window"
            >
                ğŸ•’
            </button>
        </div>
        <div class="container my-4">
            <!-- æ ‡é¢˜ + æ ‡ç­¾ -->
            <div class="d-flex flex-column mb-4">
                <div
                    class="d-flex justify-content-between align-items-start mb-4"
                >
                    <h1 class="mb-0">ğŸ¦ åˆ†é•œç‹®</h1>
                    <!-- é¡¶éƒ¨æ ‡ç­¾ï¼ˆé€‰é¡¹å¡ï¼‰ -->
                    <ul class="nav nav-tabs ms-4" id="topTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link active"
                                id="quick-gen-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#quick-gen"
                                type="button"
                                role="tab"
                                aria-controls="quick-gen"
                                aria-selected="true"
                            >
                                å¿«é€Ÿç”Ÿå›¾
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="image-split-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#image-split"
                                type="button"
                                role="tab"
                                aria-controls="image-split"
                                aria-selected="false"
                            >
                                å›¾ç‰‡ç¼–è¾‘
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="storyboard-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#storyboard"
                                type="button"
                                role="tab"
                                aria-controls="storyboard"
                                aria-selected="false"
                            >
                                æ•…äº‹æ¿
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Tab å†…å®¹ -->
            <div class="tab-content" id="topTabsContent">
                <!-- Tab å†…å®¹åŒºåŸŸ -->
                <div class="tab-content" id="topTabsContent">
                    <!-- å¿«é€Ÿç”Ÿå›¾ï¼ˆå½“å‰é¡µé¢å†…å®¹ï¼‰ -->
                    <div
                        class="tab-pane fade show active"
                        id="quick-gen"
                        role="tabpanel"
                        aria-labelledby="quick-gen-tab"
                    >
                        <!-- åŸæœ‰çš„å·¦å³ä¸¤æ å¸ƒå±€ -->
                        <div class="row">
                            <!-- è¡¨å• -->
                            <div class="col-lg-6">
                                <!-- ä½ åŸæ¥çš„ä¸Šä¼ å’Œå‚æ•°å¡ç‰‡ -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        ä¸Šä¼ å‚è€ƒå›¾ï¼ˆæœ€å¤š10å¼ ï¼‰
                                    </div>
                                    <div class="card-body">
                                        <!-- éšè—åŸç”Ÿ input -->
                                        <input
                                            type="file"
                                            id="imageUpload"
                                            multiple
                                            accept="image/*"
                                            class="d-none"
                                        />

                                        <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                                        <div
                                            id="dropZone"
                                            class="dashed-upload text-center py-4 mb-2"
                                        >
                                            <div class="text-muted">
                                                ğŸ“ æ‹–æ‹½å›¾ç‰‡è‡³æ­¤ï¼Œæˆ–
                                                <u>ç‚¹å‡»ä¸Šä¼ </u>
                                            </div>
                                        </div>

                                        <!-- ä¸Šä¼ è¿›åº¦æ¡ï¼ˆåˆå§‹éšè—ï¼‰ -->
                                        <div
                                            id="uploadProgress"
                                            class="mt-2"
                                            style="display: none"
                                        >
                                            <div
                                                class="progress"
                                                style="height: 8px"
                                            >
                                                <div
                                                    class="progress-bar progress-bar-striped progress-bar-animated"
                                                    role="progressbar"
                                                    style="width: 0%"
                                                ></div>
                                            </div>
                                            <small class="text-muted"
                                                >ä¸Šä¼ ä¸­...</small
                                            >
                                        </div>

                                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                                        <ul
                                            id="uploadPreview"
                                            class="d-flex flex-wrap gap-2 p-0 m-0"
                                        ></ul>
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header">ç”Ÿæˆå‚æ•°</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label"
                                                >åˆ†è¾¨ç‡</label
                                            >
                                            <select
                                                id="resolution"
                                                class="form-select"
                                            >
                                                <option value="1K">1K</option>
                                                <option value="2K" selected>
                                                    2K
                                                </option>
                                                <option value="4K">4K</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                >é•¿å®½æ¯”</label
                                            >
                                            <select
                                                id="aspectRatio"
                                                class="form-select"
                                            >
                                                <option value="auto">
                                                    Auto
                                                </option>
                                                <option value="1:1">1:1</option>
                                                <option value="16:9">
                                                    16:9
                                                </option>
                                                <option value="9:16">
                                                    9:16
                                                </option>
                                                <option value="4:3">4:3</option>
                                                <option value="3:4">3:4</option>
                                                <option value="3:2">3:2</option>
                                                <option value="2:3">2:3</option>
                                                <option value="5:4">5:4</option>
                                                <option value="4:5">4:5</option>
                                                <option value="21:9">
                                                    21:9
                                                </option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                >æç¤ºè¯æ¨¡å¼</label
                                            >
                                            <div class="form-check">
                                                <input
                                                    class="form-check-input"
                                                    type="radio"
                                                    name="mode"
                                                    id="modeRaw"
                                                    value="raw"
                                                    checked
                                                />
                                                <label
                                                    class="form-check-label"
                                                    for="modeRaw"
                                                    >Raw æ¨¡å¼</label
                                                >
                                            </div>
                                            <div class="form-check">
                                                <input
                                                    class="form-check-input"
                                                    type="radio"
                                                    name="mode"
                                                    id="modeStoryboard"
                                                    value="storyboard"
                                                />
                                                <label
                                                    class="form-check-label"
                                                    for="modeStoryboard"
                                                    >åˆ†é•œæ¨¡å¼</label
                                                >
                                            </div>
                                            <div class="form-check">
                                                <input
                                                    class="form-check-input"
                                                    type="radio"
                                                    name="mode"
                                                    id="modeCharacter"
                                                    value="character"
                                                />
                                                <label
                                                    class="form-check-label"
                                                    for="modeCharacter"
                                                    >è§’è‰²æ¨¡å¼</label
                                                >
                                            </div>
                                        </div>

                                        <div id="rawSection">
                                            <textarea
                                                id="promptRaw"
                                                class="form-control"
                                                rows="4"
                                                placeholder="è¯·è¾“å…¥æç¤ºè¯..."
                                            ></textarea>
                                        </div>
                                        <div
                                            id="storyboardSection"
                                            style="display: none"
                                        >
                                            <input
                                                type="text"
                                                id="prePrompt"
                                                class="form-control mb-2"
                                                placeholder="å‰ææè¿°"
                                            />
                                            <input
                                                type="text"
                                                id="style"
                                                class="form-control mb-2"
                                                placeholder="é£æ ¼"
                                            />
                                            <textarea
                                                id="shot1"
                                                class="form-control mb-2"
                                                placeholder="åˆ†é•œä¸€"
                                            ></textarea>
                                            <textarea
                                                id="shot2"
                                                class="form-control mb-2"
                                                placeholder="åˆ†é•œäºŒ"
                                            ></textarea>
                                            <textarea
                                                id="shot3"
                                                class="form-control mb-2"
                                                placeholder="åˆ†é•œä¸‰"
                                            ></textarea>
                                            <textarea
                                                id="shot4"
                                                class="form-control"
                                                placeholder="åˆ†é•œå››"
                                            ></textarea>
                                        </div>
                                        <div
                                            id="characterSection"
                                            style="display: none"
                                        >
                                            <div class="mb-3">
                                                <label class="form-label"
                                                    >è§’è‰²è§†è§’ï¼ˆå¯å¤šé€‰ï¼‰</label
                                                >
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewFront"
                                                        value="æ­£é¢å…¨èº«"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewFront"
                                                        >æ­£é¢å…¨èº«</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewSide"
                                                        value="ä¾§é¢å…¨èº«"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewSide"
                                                        >ä¾§é¢å…¨èº«</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewBack"
                                                        value="èƒŒé¢å…¨èº«"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewBack"
                                                        >èƒŒé¢å…¨èº«</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewFace"
                                                        value="é¢éƒ¨ç‰¹å†™"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewFace"
                                                        >é¢éƒ¨ç‰¹å†™</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewSolidBg"
                                                        value="çº¯è‰²èƒŒæ™¯"
                                                        checked
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewSolidBg"
                                                        >çº¯è‰²èƒŒæ™¯</label
                                                    >
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label"
                                                    >å…¶ä»–è¯´æ˜ï¼ˆé£æ ¼/å§¿æ€ï¼‰</label
                                                >
                                                <textarea
                                                    id="characterNotes"
                                                    class="form-control"
                                                    rows="2"
                                                    placeholder="ä¾‹å¦‚ï¼šæ—¥ç³»äºŒæ¬¡å…ƒï¼Œç«™å§¿è‡ªç„¶ï¼Œè¡¨æƒ…æ¸©å’Œ..."
                                                ></textarea>
                                            </div>
                                        </div>

                                        <div class="mt-3">
                                            <label class="form-label"
                                                >æç¤ºè¯é¢„è§ˆ</label
                                            >
                                            <div
                                                id="promptPreview"
                                                class="alert alert-secondary"
                                                style="
                                                    white-space: pre-wrap;
                                                    min-height: 60px;
                                                "
                                            ></div>
                                        </div>

                                        <button
                                            id="generateBtn"
                                            class="btn btn-primary w-100 mt-3"
                                        >
                                            ç”Ÿæˆå›¾ç‰‡
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- é¢„è§ˆ -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">ç”Ÿæˆé¢„è§ˆ</div>
                                    <div
                                        class="card-body preview-container"
                                        id="generatedPreview"
                                    >
                                        <p class="text-muted">
                                            ç‚¹å‡»â€œç”Ÿæˆå›¾ç‰‡â€åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨æ­¤å¤„ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›¾ç‰‡ç¼–è¾‘ -->
                    <div
                        class="tab-pane fade"
                        id="image-split"
                        role="tabpanel"
                        aria-labelledby="image-split-tab"
                    >
                        <!-- åœ¨â€œå›¾ç‰‡ç¼–è¾‘â€ Tab çš„å·¥å…·æ ä¸­ -->
                        <div
                            class="d-flex justify-content-between align-items-center mb-3"
                        >
                            <h5 class="mb-0">å›¾ç‰‡ç¼–è¾‘</h5>
                            <div class="d-flex gap-2">
                                <!-- æ–°å¢ï¼šè£å‰ªæ¨¡å¼é€‰æ‹© -->
                                <select
                                    id="cropMode"
                                    class="form-select form-select-sm"
                                    style="width: auto"
                                >
                                    <option value="quadrants">å››æ ¼è£å‰ª</option>
                                    <option value="free">è‡ªç”±è£å‰ª</option>
                                </select>
                                <button
                                    id="cropToQuadrantsBtn"
                                    class="btn btn-success btn-sm me-2"
                                    disabled
                                >
                                    è£å‰ª
                                </button>
                                <button
                                    id="swapFaceBtn"
                                    class="btn btn-outline-primary btn-sm me-2"
                                    disabled
                                >
                                    æ¢è„¸
                                </button>
                                <button
                                    id="saveCroppedImagesBtn"
                                    class="btn btn-primary btn-sm"
                                    disabled
                                >
                                    ä¿å­˜
                                </button>
                            </div>
                        </div>

                        <!-- ç¼–è¾‘åŒºåŸŸå®¹å™¨ -->
                        <div
                            id="imageEditContainer"
                            class="position-relative border rounded bg-dark-subtle"
                            style="width: 100%; height: 70vh"
                        >
                            <!-- å ä½æç¤ºï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
                            <div
                                id="imageEditPlaceholder"
                                class="d-flex justify-content-center align-items-center h-100 w-100 text-muted"
                                style="position: absolute; inset: 0; z-index: 1"
                            >
                                è¯·æ‹–å…¥ä¸€å¼ å›¾ç‰‡ä»¥å¼€å§‹ç¼–è¾‘
                            </div>

                            <!-- Canvasï¼ˆå§‹ç»ˆå­˜åœ¨ï¼Œä½†åˆå§‹æ— å†…å®¹ï¼‰ -->
                            <canvas
                                id="editCanvas"
                                class="w-100 h-100"
                                style="display: block; background: #121212"
                            ></canvas>

                            <!-- éšè—çš„å›¾ç‰‡åŠ è½½å™¨ -->
                            <img
                                id="hiddenImageLoader"
                                style="display: none"
                                crossorigin="anonymous"
                            />
                        </div>
                    </div>

                    <!-- æ•…äº‹æ¿ -->
                    <div
                        class="tab-pane fade"
                        id="storyboard"
                        role="tabpanel"
                        aria-labelledby="storyboard-tab"
                    >
                        <!-- é¡¶éƒ¨å·¥å…·æ  -->
                        <div
                            class="d-flex justify-content-between align-items-center mb-3"
                        >
                            <div class="d-flex align-items-center gap-2 mb-0">
                                <!-- å¯ç¼–è¾‘æ ‡é¢˜ -->
                                <div
                                    class="storyboard-title-container d-flex align-items-center"
                                >
                                    <div
                                        class="storyboard-title-display d-flex align-items-center"
                                    >
                                        <span id="storyboardTitleText"
                                            >æœªå‘½åæ•…äº‹æ¿</span
                                        >
                                        <button
                                            id="editTitleBtn"
                                            class="btn btn-link text-light p-0 ms-2"
                                            style="
                                                font-size: 0.9em;
                                                opacity: 0.6;
                                            "
                                            title="é‡å‘½å"
                                        >
                                            âœï¸
                                        </button>
                                    </div>
                                    <input
                                        type="text"
                                        id="storyboardTitleInput"
                                        class="form-control form-control-sm d-none"
                                        value="æœªå‘½åæ•…äº‹æ¿"
                                        style="
                                            width: auto;
                                            min-width: 120px;
                                            display: inline-block;
                                        "
                                    />
                                </div>
                                <!-- ä¸‹æ‹‰æŒ‰é’® -->
                                <div class="dropdown">
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        type="button"
                                        id="storyboardDropdownBtn"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        style="padding: 0.25rem 0.5rem"
                                    >
                                        â–¼
                                    </button>
                                    <ul
                                        class="dropdown-menu dropdown-menu-end"
                                        aria-labelledby="storyboardDropdownBtn"
                                        id="storyboardDropdownMenu"
                                    >
                                        <li>
                                            <a
                                                class="dropdown-item"
                                                href="#"
                                                data-action="new"
                                                >ğŸ†• æ–°å»ºæ•…äº‹æ¿</a
                                            >
                                        </li>
                                        <li><hr class="dropdown-divider" /></li>
                                        <!-- åŠ¨æ€æ•…äº‹æ¿åˆ—è¡¨å°†æ’å…¥åˆ°è¿™é‡Œ -->
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button
                                    id="addStoryboardPanelBtn"
                                    class="btn btn-outline-info btn-sm"
                                >
                                    + æ·»åŠ åˆ†é•œ
                                </button>
                                <button
                                    id="saveStoryboardBtn"
                                    class="btn btn-primary btn-sm"
                                    disabled
                                >
                                    ä¿å­˜
                                </button>
                            </div>
                        </div>

                        <!-- æ‹–å…¥æç¤º / é¢æ¿å®¹å™¨ï¼ˆä¸å˜ï¼‰ -->
                        <div
                            id="storyboardPlaceholder"
                            class="d-flex justify-content-center align-items-center text-muted py-5"
                            style="min-height: 300px"
                        >
                            ğŸï¸ æ·»åŠ åˆ†é•œï¼Œæˆ–ä»ä¸‹æ‹‰èœå•é€‰æ‹©æ•…äº‹æ¿
                        </div>
                        <div
                            id="storyboardPanels"
                            class="row g-3"
                            style="display: none"
                        ></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨å±€æç¤ºå®¹å™¨ -->
        <div
            id="globalToastContainer"
            class="position-fixed top-0 end-0 p-3"
            style="z-index: 1055; pointer-events: none"
        >
            <!-- åŠ¨æ€ toast å°†è¢«æ’å…¥åˆ°è¿™é‡Œ -->
        </div>

        <!-- å…¨å±é®ç½©ï¼ˆç”¨äºæ¢è„¸ç­‰è€—æ—¶æ“ä½œï¼‰ -->
        <div
            id="fullscreenMask"
            class="position-fixed top-0 start-0 w-100 h-100 d-none"
            style="
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1050;
                display: none;
            "
        >
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-light text-center">
                    <div
                        class="spinner-border text-light mb-2"
                        role="status"
                    ></div>
                    <div>æ­£åœ¨å¤„ç†æ¢è„¸ï¼Œè¯·ç¨å€™...</div>
                </div>
            </div>
        </div>

        <!-- å¿«æ·è®¿é—®çª—å£ -->
        <div id="quickAccessWindow" class="floating-window d-none">
            <div class="floating-header">
                <span>å¿«æ·è®¿é—®</span>
                <button
                    type="button"
                    class="btn-close"
                    data-dismiss="quick-access"
                ></button>
            </div>
            <div class="quick-images-container"></div>
        </div>

        <!-- å†å²è®°å½•çª—å£ -->
        <div id="historyWindow" class="floating-window d-none">
            <div class="floating-header">
                <span>å†å²è®°å½•</span>
                <button
                    type="button"
                    class="btn-close"
                    data-dismiss="history-window"
                ></button>
            </div>
            <div class="history-content">
                <div id="historyWindowList" class="row"></div>
                <nav aria-label="å†å²ç¿»é¡µ" class="mt-2">
                    <ul
                        class="pagination justify-content-center"
                        id="historyWindowPagination"
                    ></ul>
                </nav>
            </div>
        </div>

        <!-- å›¾ç‰‡è¯¦æƒ…Modal -->
        <div id="historyDetailModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title">å†å²è®°å½•è¯¦æƒ…</h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer"></div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
        <script src="{{ url_for('static', filename='state.js') }}"></script>
        <script src="{{ url_for('static', filename='upload.js') }}"></script>
        <script src="{{ url_for('static', filename='quick-access.js') }}"></script>
        <script src="{{ url_for('static', filename='image-edit.js') }}"></script>
        <script src="{{ url_for('static', filename='storyboard.js') }}"></script>
        <script src="{{ url_for('static', filename='main.js') }}"></script>
    </body>
</html>


---------------------
main.js å†…å®¹å¦‚ä¸‹
--------------------
// main.js
//

(function () {
  const state = window.AIImageState;
  const ITEMS_PER_PAGE = 12;

  // ===== æç¤ºè¯é¢„è§ˆ =====
  function updatePromptPreview() {
    let text = "";
    if ($("#modeRaw").is(":checked")) {
      text = $("#promptRaw").val();
    } else if ($("#modeStoryboard").is(":checked")) {
      const pre = $("#prePrompt").val();
      const style = $("#style").val();
      const s1 = $("#shot1").val();
      const s2 = $("#shot2").val();
      const s3 = $("#shot3").val();
      const s4 = $("#shot4").val();
      text = `${pre}ï¼Œç”Ÿæˆå››æ ¼åˆ†é•œï¼ˆ${style}ï¼‰ï¼š\nåˆ†é•œä¸€ï¼š${s1}\nåˆ†é•œäºŒï¼š${s2}\nåˆ†é•œä¸‰ï¼š${s3}\nåˆ†é•œå››ï¼š${s4}`;
    } else if ($("#modeCharacter").is(":checked")) {
      // è§’è‰²æ¨¡å¼é€»è¾‘
      const views = [];
      if ($("#viewFront").is(":checked")) views.push("æ­£é¢å…¨èº«");
      if ($("#viewSide").is(":checked")) views.push("ä¾§é¢å…¨èº«");
      if ($("#viewBack").is(":checked")) views.push("èƒŒé¢å…¨èº«");
      if ($("#viewFace").is(":checked")) views.push("é¢éƒ¨ç‰¹å†™");
      if ($("#viewSolidBg").is(":checked")) views.push("çº¯è‰²èƒŒæ™¯");

      if (views.length === 0) {
        text = "ï¼ˆè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§†è§’ï¼‰";
      } else {
        const viewText = views.join("å’Œ");
        const notes = $("#characterNotes").val().trim();
        text = `ç»™æˆ‘ä¸€ä¸ªè¿™ä¸ªè§’è‰²çš„${viewText}ã€‚è¦æ±‚è§’è‰²é¢éƒ¨ç‰¹å¾ä¿æŒä¸€è‡´ã€‚${notes ? " " + notes : ""}`;
      }
    }
    $("#promptPreview").text(text || "ï¼ˆæç¤ºè¯ä¸ºç©ºï¼‰");
  }

  // ===== ç”Ÿæˆå›¾ç‰‡ =====
  let isGenerating = false;
  $("#generateBtn").click(function () {
    if (isGenerating) return;
    const prompt = $("#promptPreview").text().trim();
    if (!prompt || prompt === "ï¼ˆæç¤ºè¯ä¸ºç©ºï¼‰") {
      alert("è¯·å¡«å†™æç¤ºè¯");
      return;
    }

    isGenerating = true;
    $(this).prop("disabled", true).text("ç”Ÿæˆä¸­...");

    $.ajax({
      url: "/generate",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        image_urls: state.getUploadedUrls(),
        local_input_paths: state.getLocalPaths(),
        prompt: prompt,
        size: $("#resolution").val(),
        aspect_ratio: $("#aspectRatio").val(),
      }),
      success: function (res) {
        if (res.success) {
          let html = "";
          res.result_urls.forEach((url) => {
            html += `
                            <div class="mb-3">
                                <a href="${url}" data-lightbox="generated"><img src="${url}" class="img-fluid rounded" style="max-height:300px;"></a>
                                <div class="mt-2">
                                    <a href="${url}" download class="btn btn-sm btn-outline-light">ä¸‹è½½</a>
                                </div>
                            </div>
                        `;
          });
          $("#generatedPreview").html(html);
          loadHistoryPage(1);
        } else {
          alert("ç”Ÿæˆå¤±è´¥: " + (res.error || "æœªçŸ¥é”™è¯¯"));
        }
      },
      error: function (xhr) {
        const err = xhr.responseJSON?.error || "è¯·æ±‚å¤±è´¥";
        alert("ç”Ÿæˆé”™è¯¯: " + err);
      },
      complete: function () {
        isGenerating = false;
        $("#generateBtn").prop("disabled", false).text("ç”Ÿæˆå›¾ç‰‡");
      },
    });
  });

  // ===== å†å²è®°å½• =====
  function showParamsModal(item) {
    let inputHtml = "";
    if (item.input_paths && item.input_paths.length > 0) {
      inputHtml = '<h5>è¾“å…¥å‚è€ƒå›¾ï¼š</h5><div class="d-flex flex-wrap gap-2">';
      item.input_paths.forEach((url) => {
        inputHtml += `<a href="${url}" data-lightbox="inputs-${item.id}"><img src="${url}" style="width:60px;height:60px;object-fit:cover;"></a>`;
      });
      inputHtml += "</div>";
    }

    const modalHtml = `
            <div class="modal fade" id="paramsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content bg-dark text-light">
                        <div class="modal-header">
                            <h5 class="modal-title">ç”Ÿæˆå‚æ•°</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>æç¤ºè¯ï¼š</strong>${item.params.prompt.replace(/\n/g, "<br>")}</p>
                            <p><strong>åˆ†è¾¨ç‡ï¼š</strong>${item.params.size}</p>
                            <p><strong>é•¿å®½æ¯”ï¼š</strong>${item.params.aspect_ratio}</p>
                            <p><strong>ç”Ÿæˆæ—¶é—´ï¼š</strong>${new Date(item.timestamp).toLocaleString("zh-CN")}</p>
                            ${inputHtml}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    $("#historyList").append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById("paramsModal"));
    modal.show();
    $("#paramsModal").on("hidden.bs.modal", function () {
      $(this).remove();
    });
  }

  /**
   * å°†æŒ‡å®šå›¾ç‰‡è½½å…¥â€œå›¾ç‰‡ç¼–è¾‘â€æ ‡ç­¾é¡µå¹¶æ¿€æ´»
   * @param {Object} item - åŒ…å« localPath æˆ– remoteUrl çš„å¯¹è±¡
   */
  function enterImageEditMode(item) {
    // 1. åˆ‡æ¢åˆ°â€œå›¾ç‰‡ç¼–è¾‘â€æ ‡ç­¾
    const editTabBtn = document.querySelector("#image-split-tab");
    if (editTabBtn) {
      const tab = new bootstrap.Tab(editTabBtn);
      tab.show();
    }

    // 2. ä¼˜å…ˆä½¿ç”¨æœ¬åœ°è·¯å¾„ï¼ˆlocalPathï¼‰ï¼Œæ²¡æœ‰åˆ™ç”¨è¿œç¨‹ URLï¼ˆremoteUrlï¼‰
    const imgUrl = item.localPath || item.remoteUrl;
    if (!imgUrl) {
      console.warn("No image URL to edit", item);
      return;
    }

    // 3. è§¦å‘å›¾ç‰‡åŠ è½½ï¼ˆä¸ drag-drop é€»è¾‘ä¸€è‡´ï¼‰
    $("#hiddenImageLoader").attr("src", imgUrl);
    $("#imageEditPlaceholder").hide();
  }

  function loadHistoryPage(page) {
    $.get(
      "/history?page=" + page + "&limit=" + ITEMS_PER_PAGE,
      function (data) {
        let html = "";
        data.records.forEach((item) => {
          const url = item.result_paths[0] || "";
          html += `
            <div class="col-6 col-sm-4 col-md-2 mb-3">
              <div class="card history-card" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                <a href="javascript:void(0);" class="history-img-link">
                  <img src="${url}" class="w-100 history-img" style="aspect-ratio:1/1;object-fit:cover;" draggable="true" data-history-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                </a>
              </div>
            </div>
          `;
        });
        $("#historyList").html(html);

        let pg = "";
        for (let i = 1; i <= data.pages; i++) {
          pg += `<li class="page-item ${i === page ? "active" : ""}"><a class="page-link" href="#">${i}</a></li>`;
        }
        $("#historyPagination").html(pg);

        // âœ… ä»…åœ¨ shouldHighlightNewRecords ä¸º true æ—¶æ‰§è¡Œé«˜äº®å’Œæ»šåŠ¨
        if (shouldHighlightNewRecords) {
          shouldHighlightNewRecords = false; // é‡ç½®æ ‡å¿—ï¼Œåªè§¦å‘ä¸€æ¬¡

          const cards = document.querySelectorAll("#quick-gen .history-card");
          const count = Math.min(4, cards.length);

          // é«˜äº®å‰ 4 å¼ 
          for (let i = 0; i < count; i++) {
            const card = cards[i];
            card.style.transition = "background-color 1.5s ease";
            card.style.backgroundColor = "#ffeb3b";

            setTimeout(() => {
              card.style.backgroundColor = "";
            }, 1500);
          }

          // æ»šåŠ¨åˆ° #quick-gen å®¹å™¨åº•éƒ¨ï¼ˆæˆ– historyList åº•éƒ¨ï¼‰
          const quickGenContainer = document.getElementById("quick-gen");
          if (quickGenContainer) {
            // ä½¿ç”¨ smooth æ»šåŠ¨åˆ°åº•éƒ¨
            quickGenContainer.scrollIntoView({
              behavior: "smooth",
              block: "end",
            });
            // æˆ–è€…å¦‚æœä½ å¸Œæœ›æ»šåŠ¨çš„æ˜¯æ•´ä¸ªé¡µé¢åˆ°åº•éƒ¨ï¼ˆå–å†³äºå¸ƒå±€ï¼‰ï¼š
            // window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
          }
        }
      },
    );
  }

  // ===== äº‹ä»¶ç»‘å®š =====
  $(document).ready(function () {
    // æ¨¡å¼åˆ‡æ¢
    $('input[name="mode"]').change(function () {
      $("#rawSection").toggle(this.value === "raw");
      $("#storyboardSection").toggle(this.value === "storyboard");
      $("#characterSection").toggle(this.value === "character");
      updatePromptPreview();
    });

    $(
      "#promptRaw, #prePrompt, #style, #shot1, #shot2, #shot3, #shot4, #characterNotes",
    ).on("input", updatePromptPreview);

    // å¤é€‰æ¡†å˜åŒ–ä¹Ÿè¦è§¦å‘é¢„è§ˆæ›´æ–°
    $("#characterSection input[type='checkbox']").on(
      "change",
      updatePromptPreview,
    );

    $(document).on("click", "#historyPagination .page-link", function (e) {
      e.preventDefault();
      loadHistoryPage(parseInt($(this).text()));
    });

    // åˆå§‹åŒ–
    updatePromptPreview();
    loadHistoryPage(1);

    // å¦‚æœä½ å¸Œæœ›åœ¨åˆ‡æ¢æ ‡ç­¾æ—¶æ‰§è¡ŒæŸäº› JS é€»è¾‘ï¼ˆä¾‹å¦‚æ‡’åŠ è½½ã€åˆå§‹åŒ–ç»„ä»¶ç­‰ï¼‰ï¼Œå¯ä»¥ç›‘å¬ Bootstrap çš„ shown.bs.tab äº‹ä»¶ï¼š
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach((tab) => {
      tab.addEventListener("shown.bs.tab", (event) => {
        const targetId = event.target.getAttribute("data-bs-target");
        console.log("åˆ‡æ¢åˆ°æ ‡ç­¾:", targetId);
      });
    });

    // ===== æ‹–æ‹½åˆ°ç›®æ ‡åŒºåŸŸé€»è¾‘ =====

    // ç›‘å¬ dragendï¼ˆå–æ¶ˆï¼‰
    $(document).on("dragend dragcancel", "*", function () {
      cleanupDragState();
    });

    // ç‚¹å‡»å†å²å¡ç‰‡ï¼Œå¼¹å‡ºè¯¦æƒ…æµ®çª—
    $(document).on("click", ".history-card", function (e) {
      const item = $(this).data("item");
      showHistoryDetailModal(item);
    });

    function showHistoryDetailModal(item) {
      const isFromQuick = item.id?.startsWith("quick-");
      const resultUrl = item.result_paths[0] || item.result_urls[0] || "";

      const hideUseParams =
        item.params.prompt === "free crop" ||
        item.params.prompt === "quadrants crop";

      // æ„å»ºå†…å®¹ï¼ˆå’ŒåŸæ¥ä¸€æ ·ï¼Œä½†ä¸å†åŒ…å«å¤–å±‚ modal ç»“æ„ï¼‰
      const deleteBtn = isFromQuick
        ? ""
        : `<button type="button" class="btn btn-outline-danger btn-sm" id="deleteHistoryBtn" data-id="${item.id}">åˆ é™¤</button>`;

      const useParamsBtn = hideUseParams
        ? ""
        : `<button type="button" class="btn btn-outline-primary" id="useParamsBtn" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>å¤åˆ»</button>`;

      let paramsText = "";
      if (!hideUseParams) {
        paramsText = `
          <strong>æç¤ºè¯ï¼š</strong>${item.params.prompt.replace(/\n/g, "<br>")}<br>
          <strong>åˆ†è¾¨ç‡ï¼š</strong>${item.params.size}<br>
          <strong>é•¿å®½æ¯”ï¼š</strong>${item.params.aspect_ratio}<br>
          <strong>ç”Ÿæˆæ—¶é—´ï¼š</strong>${new Date(item.timestamp).toLocaleString("zh-CN")}
        `;
      }

      let inputHtml = "";
      if (item.input_paths && item.input_paths.length > 0) {
        inputHtml =
          '<h5 class="mt-3">è¾“å…¥å‚è€ƒå›¾ï¼š</h5><div class="d-flex flex-wrap gap-2">';
        item.input_paths.forEach((url) => {
          inputHtml += `<img src="${url}" style="width:50px;height:50px;object-fit:cover;">`;
        });
        inputHtml += "</div>";
      }

      // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
      const $modal = $("#historyDetailModal");
      $modal.find(".modal-body").html(`
        <div class="text-center mb-3">
          <a href="${resultUrl}" data-lightbox="history-detail">
            <img src="${resultUrl}" class="img-fluid rounded" style="max-height:400px;">
          </a>
        </div>
        ${paramsText}
        ${inputHtml}
      `);

      $modal.find(".modal-footer").html(`
        ${deleteBtn}
        <button type="button" class="btn btn-outline-info" id="editHistoryBtn" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>ç¼–è¾‘</button>
        ${useParamsBtn}
        <button type="button" class="btn btn-outline-success" id="useAsReferenceBtn"
          data-local="${resultUrl}"
          data-remote="${resultUrl}"
          data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
          ä½œä¸ºå‚è€ƒå›¾
        </button>
      `);

      // åˆå§‹åŒ–æˆ–è·å–å·²æœ‰çš„ Modal å®ä¾‹ï¼ˆæ¨èç¼“å­˜ï¼Œä½†ç®€å•åœºæ™¯å¯æ¯æ¬¡éƒ½ newï¼‰
      const modalInstance = bootstrap.Modal.getOrCreateInstance($modal[0]);
      modalInstance.show();
    }
    // æš´éœ²æ–¹æ³•åˆ°å…¨å±€
    window.showHistoryDetailModal = showHistoryDetailModal;

    // ä½¿ç”¨å‚æ•°ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
    $(document).on("click", "#useParamsBtn", function () {
      const item = $(this).data("item");
      // === ä»¥ä¸‹å¤ç”¨ä½ åŸæœ‰çš„â€œä½¿ç”¨å‚æ•°â€é€»è¾‘ ===
      const params = item.params;

      // åˆ¤æ–­æ¨¡å¼ï¼ˆRaw / Storyboard / Characterï¼‰
      let isCharacter = params.prompt.includes("é¢éƒ¨ç‰¹å¾ä¿æŒä¸€è‡´");
      let isStoryboard = params.prompt.includes("ç”Ÿæˆå››æ ¼åˆ†é•œ");

      if (isCharacter) {
        $("#modeCharacter").prop("checked", true).trigger("change");
        // æ¸…ç©ºå¤é€‰æ¡†
        $("#characterSection input[type='checkbox']").prop("checked", false);
        const prompt = params.prompt;
        if (prompt.includes("æ­£é¢å…¨èº«")) $("#viewFront").prop("checked", true);
        if (prompt.includes("ä¾§é¢å…¨èº«")) $("#viewSide").prop("checked", true);
        if (prompt.includes("èƒŒé¢å…¨èº«")) $("#viewBack").prop("checked", true);
        if (prompt.includes("é¢éƒ¨ç‰¹å†™")) $("#viewFace").prop("checked", true);
        if (prompt.includes("çº¯è‰²èƒŒæ™¯"))
          $("#viewSolidBg").prop("checked", true);

        const notesMatch = prompt.match(/é¢éƒ¨ç‰¹å¾ä¿æŒä¸€è‡´\ã€‚ï¼ˆ.*?ï¼‰?$/);
        $("#characterNotes").val(notesMatch ? notesMatch[1] || "" : "");
      } else if (isStoryboard) {
        $("#modeStoryboard").prop("checked", true).trigger("change");
        const lines = params.prompt.split("\n");
        const preMatch = lines[0]?.match(/^(.+)ï¼Œç”Ÿæˆå››æ ¼åˆ†é•œ/);
        $("#prePrompt").val(preMatch ? preMatch[1] : "");
        const styleMatch = lines[0]?.match(/ç”Ÿæˆå››æ ¼åˆ†é•œï¼ˆ(.+?)ï¼‰/);
        $("#style").val(styleMatch ? styleMatch[1] : "");
        $("#shot1").val(lines[1]?.replace("åˆ†é•œä¸€ï¼š", "") || "");
        $("#shot2").val(lines[2]?.replace("åˆ†é•œäºŒï¼š", "") || "");
        $("#shot3").val(lines[3]?.replace("åˆ†é•œä¸‰ï¼š", "") || "");
        $("#shot4").val(lines[4]?.replace("åˆ†é•œå››ï¼š", "") || "");
      } else {
        $("#modeRaw").prop("checked", true).trigger("change");
        $("#promptRaw").val(params.prompt);
      }

      $("#resolution").val(params.size || "2K");
      $("#aspectRatio").val(params.aspect_ratio || "auto");

      // æ¢å¤å‚è€ƒå›¾
      state.clear();
      if (item.input_paths && item.input_paths.length > 0) {
        state.setFromUrls(item.input_urls, item.input_paths);
      }
      if (typeof window.UploadModule?.renderPreview === "function") {
        window.UploadModule.renderPreview();
      }

      updatePromptPreview();
      $("html, body").animate({ scrollTop: 0 }, 300);

      // å…³é—­æµ®çª—
      bootstrap.Modal.getInstance(
        document.getElementById("historyDetailModal"),
      )?.hide();
    });

    // åˆ é™¤è®°å½•
    $(document).on("click", "#deleteHistoryBtn", function () {
      const recordId = $(this).data("id");
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ")) return;

      $.ajax({
        url: `/history/${recordId}`,
        method: "DELETE",
        success: function (res) {
          if (res.success) {
            // å…³é—­æµ®çª—
            bootstrap.Modal.getInstance(
              document.getElementById("historyDetailModal"),
            )?.hide();
            // é‡æ–°åŠ è½½å½“å‰é¡µ
            const currentPage =
              parseInt(
                $("#historyPagination .page-item.active .page-link").text(),
              ) || 1;
            loadHistoryPage(currentPage);
          } else {
            alert("åˆ é™¤å¤±è´¥: " + (res.error || "æœªçŸ¥é”™è¯¯"));
          }
        },
        error: function () {
          alert("åˆ é™¤è¯·æ±‚å¤±è´¥");
        },
      });
    });

    // ç¼–è¾‘æŒ‰é’®
    $(document).on("click", "#editHistoryBtn", function () {
      const item = $(this).data("item");

      // æ„é€ ä¸æ‹–æ‹½é€»è¾‘ä¸€è‡´çš„ item ç»“æ„ï¼š{ localPath, remoteUrl }
      const editItem = {
        localPath: item.result_paths?.[0] || item.result_urls?.[0], // ä¼˜å…ˆæœ¬åœ°è·¯å¾„
        remoteUrl: item.result_urls?.[0],
      };

      enterImageEditMode(editItem);

      // å…³é—­æµ®çª—
      bootstrap.Modal.getInstance(
        document.getElementById("historyDetailModal"),
      )?.hide();
    });

    // æ–°å¢ï¼šä½œä¸ºå‚è€ƒå›¾
    $(document).on("click", "#useAsReferenceBtn", async function () {
      const localPath = $(this).data("local");
      const remoteUrl = $(this).data("remote");
      const item = $(this).data("item");

      let usableLocal = localPath;
      let usableRemote = remoteUrl;

      // è‹¥æ²¡æœ‰æœ‰æ•ˆçš„ ImgBB è¿œç¨‹åœ°å€ï¼Œå…ˆä¸Šä¼ 
      if (!usableRemote || !usableRemote.startsWith("https://")) {
        if (!usableLocal) {
          alert("æ— æ³•è·å–å›¾ç‰‡æºï¼Œæ— æ³•ä½œä¸ºå‚è€ƒå›¾");
          return;
        }

        try {
          const resp = await fetch(usableLocal);
          if (!resp.ok) throw new Error("æ— æ³•è¯»å–æœ¬åœ°å›¾ç‰‡");
          const blob = await resp.blob();
          const formData = new FormData();
          formData.append("file", blob, "reference.jpg");

          const uploadRes = await fetch("/quick-upload", {
            method: "POST",
            body: formData,
          });

          if (!uploadRes.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
          const data = await uploadRes.json();
          usableRemote = data.url;
          usableLocal = data.local_path || usableLocal;
        } catch (e) {
          console.error("ä¸Šä¼ å‚è€ƒå›¾å¤±è´¥:", e);
          showToast("ä¸Šä¼ å‚è€ƒå›¾å¤±è´¥ï¼Œè¯·é‡è¯•", "error", 3000);
          return;
        }
      }

      // åŠ å…¥å‚è€ƒå›¾
      const success = window.AIImageState?.addFromQuickAccess(
        usableLocal,
        usableRemote,
      );
      if (success) {
        if (typeof window.UploadModule?.renderPreview === "function") {
          window.UploadModule.renderPreview();
        }
        showToast("å·²æ·»åŠ ä¸ºå‚è€ƒå›¾", "success", 2000);
        // å…³é—­æ¨¡æ€æ¡†
        bootstrap.Modal.getInstance(
          document.getElementById("historyDetailModal"),
        )?.hide();
      } else {
        showToast("å‚è€ƒå›¾å·²å­˜åœ¨æˆ–æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆæœ€å¤š10å¼ ï¼‰", "warning", 2500);
      }
    });

    // ===== å·¥å…·æ¡å¼¹çª—æ§åˆ¶ =====
    $(document).on("click", ".tool-btn", function () {
      const target = $(this).data("target");
      if (target === "quick-access") {
        $("#quickAccessWindow").removeClass("d-none");
        window.QuickAccess?.renderSidebar(
          "#quickAccessWindow .quick-images-container",
        );
      } else if (target === "history-window") {
        $("#historyWindow").removeClass("d-none");
        loadHistoryWindowPage(1);
      }
    });

    // å…³é—­çª—å£
    $(document).on("click", "[data-dismiss]", function () {
      const target = $(this).data("dismiss");
      if (target === "quick-access") {
        $("#quickAccessWindow").addClass("d-none");
      } else if (target === "history-window") {
        $("#historyWindow").addClass("d-none");
      }
    });

    // å†å²çª—å£åˆ†é¡µ
    function loadHistoryWindowPage(page) {
      const ITEMS_PER_PAGE = 12;
      $.get(`/history?page=${page}&limit=${ITEMS_PER_PAGE}`, function (data) {
        let html = "";
        data.records.forEach((item) => {
          const url = item.result_paths[0] || "";
          // æ›¿æ¢åŸ img æ ‡ç­¾
          html += `
            <div class="col-6 col-sm-4 col-md-3 mb-3">
              <div class="card history-card" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                <a href="javascript:void(0);">
                  <img
                    src="${url}"
                    class="w-100"
                    style="aspect-ratio:1/1;object-fit:cover;"
                    draggable="true"
                    data-history-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'
                  >
                </a>
              </div>
            </div>
          `;
        });
        $("#historyWindowList").html(html);
        let pg = "";
        for (let i = 1; i <= data.pages; i++) {
          pg += `<li class="page-item ${i === page ? "active" : ""}"><a class="page-link" href="#">${i}</a></li>`;
        }
        $("#historyWindowPagination").html(pg);
      });
    }

    $(document).on(
      "click",
      "#historyWindowPagination .page-link",
      function (e) {
        e.preventDefault();
        loadHistoryWindowPage(parseInt($(this).text()));
      },
    );

    // å†å²çª—å£å¡ç‰‡ç‚¹å‡»
    $(document).on("click", "#historyWindowList .history-card", function () {
      const item = $(this).data("item");
      window.showHistoryDetailModal(item);
    });

    // ===== æ‹–æ‹½ç§»åŠ¨æµ®åŠ¨çª—å£ =====
    function makeWindowDraggable(windowSelector) {
      const winEl = document.querySelector(windowSelector); // â† æ”¹åï¼šwinEl
      if (!winEl) return;

      let pos1 = 0,
        pos2 = 0,
        pos3 = 0,
        pos4 = 0;

      const header = winEl.querySelector(".floating-header");
      if (!header) return;

      header.style.cursor = "move";

      header.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;

        // âœ… æ­£ç¡®è®¡ç®—æ–°ä½ç½®
        const newLeft = winEl.offsetLeft - pos1;
        const newTop = winEl.offsetTop - pos2;

        // âœ… ä½¿ç”¨å…¨å±€ window.innerWidth/Heightï¼ˆæ³¨æ„ï¼šä¸æ˜¯ winEl.innerWidthï¼ï¼‰
        const maxX = window.innerWidth - winEl.offsetWidth;
        const maxY = window.innerHeight - winEl.offsetHeight;

        // âœ… é™åˆ¶è¾¹ç•Œ
        winEl.style.left = Math.max(0, Math.min(newLeft, maxX)) + "px";
        winEl.style.top = Math.max(0, Math.min(newTop, maxY)) + "px";

        // âœ… ç§»é™¤ transformï¼ˆç¡®ä¿å®šä½åŸºäº left/topï¼‰
        winEl.style.transform = "none";
      }

      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    // åˆå§‹åŒ–æ‹–æ‹½
    makeWindowDraggable("#quickAccessWindow");
    makeWindowDraggable("#historyWindow");

    // ===== æ‚¬æµ®çª—å£å›¾ç‰‡æ‹–æ‹½æ”¯æŒ =====
    $(document).on(
      "dragstart",
      "#historyWindow .history-card img, #quickAccessWindow .quick-img-item img",
      function (e) {
        const originalEvent = e.originalEvent;
        let itemData = null;

        // æ¥æºï¼šå†å²è®°å½•
        if ($(this).closest("#historyWindow").length) {
          const item = $(this).data("history-item");
          if (item) {
            itemData = {
              type: "history",
              localPath: item.result_paths?.[0] || "",
              remoteUrl: item.result_urls?.[0] || "",
              inputPaths: item.input_paths || [],
              inputUrls: item.input_urls || [],
              params: item.params || {},
            };
          }
        }
        // æ¥æºï¼šå¿«æ·è®¿é—®
        else if ($(this).closest("#quickAccessWindow").length) {
          const item = $(this).data("quick-item");
          if (item) {
            itemData = {
              type: "quick",
              localPath: item.localPath,
              remoteUrl: item.remoteUrl,
              category: item.category,
              group: item.group,
              viewType: item.viewType,
              note: item.note,
            };
          }
        }

        if (itemData) {
          // å­˜å‚¨åˆ°å…¨å±€ï¼ˆä¾› drop åŒºåŸŸè¯»å–ï¼‰
          window.__draggedItem = itemData;

          // è®¾ç½®æ‹–å½±
          const img = this.cloneNode(true);
          img.style.width = "80px";
          img.style.height = "80px";
          img.style.opacity = "0.9";
          img.style.borderRadius = "4px";
          img.style.objectFit = "cover";
          img.style.pointerEvents = "none";
          const ghost = document.createElement("div");
          ghost.appendChild(img);
          ghost.style.position = "absolute";
          ghost.style.top = "-9999px";
          document.body.appendChild(ghost);
          originalEvent.dataTransfer.setDragImage(ghost, 40, 40);

          // æ¸…ç†
          const cleanup = () => {
            if (ghost.parentNode) ghost.parentNode.removeChild(ghost);
            document.removeEventListener("dragend", cleanup);
          };
          document.addEventListener("dragend", cleanup);

          // ä¸æ˜¾ç¤º #dragTargetOverlayï¼ˆä½ å·²ç§»é™¤ï¼Œæ‰€ä»¥è·³è¿‡ï¼‰
          return;
        }
      },
    );

    // å¿«æ·è®¿é—®çª—å£æ¥æ”¶å†å²å›¾
    $(document).on(
      "dragover",
      "#quickAccessWindow .quick-images-container",
      function (e) {
        e.preventDefault();
      },
    );
    $(document).on(
      "drop",
      "#quickAccessWindow .quick-images-container",
      function (e) {
        e.preventDefault();
        const item = window.__draggedItem;
        if (item && item.type === "history") {
          // æå–ä¸»å›¾
          const imgToAdd = {
            localPath: item.localPath,
            remoteUrl: item.remoteUrl,
          };
          window.QuickAccess?.addImage(imgToAdd);
          showToast("å·²æ·»åŠ åˆ°å¿«æ·è®¿é—®", "success", 2000);
        }
        window.__draggedItem = null;
      },
    );

    // document ready ç»“æŸ
  });
})();


---------------------
quick-access.js å†…å®¹å¦‚ä¸‹
--------------------
// static/quick-access.js
window.QuickAccess = (function () {
  const STORAGE_KEY = "quickAccessImages";
  let images = [];
  let currentFilter = "all"; // "all", "è§’è‰²", "åœºæ™¯"

  function load() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      images = saved ? JSON.parse(saved) : [];
      images.forEach((img) => {
        // è¿ç§»è€æ•°æ®
        if (img.tag && img.tag !== "å…¨éƒ¨") {
          // è€ tag â†’ category
          img.category = img.tag;
          img.group = img.title || img.tag;
          delete img.tag;
          delete img.title;
        } else if (!img.category) {
          // æœªåˆ†ç±»ï¼šæŠŠ title ä½œä¸º group
          img.category = null;
          img.group = img.title || "";
          delete img.tag;
          delete img.title;
        }
        if (!img.addedAt) img.addedAt = new Date().toISOString();
      });
    } catch (e) {
      images = [];
    }
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(images));
  }

  async function addImage({ localPath, remoteUrl }) {
    console.log([localPath, remoteUrl]);
    if (!localPath && !remoteUrl) return;

    const exists = images.some(
      (img) =>
        (img.remoteUrl === remoteUrl && remoteUrl) ||
        (img.localPath === localPath && localPath),
    );
    if (exists) return;

    let usableLocal = localPath;
    let usableRemote = remoteUrl;
    if (usableRemote && !usableRemote.startsWith("https://")) {
      usableRemote = null;
    }

    if (usableLocal && !usableRemote) {
      try {
        const resp = await fetch(usableLocal);
        const blob = await resp.blob();
        const formData = new FormData();
        formData.append("file", blob, "quick.jpg");
        const uploadRes = await fetch("/quick-upload", {
          method: "POST",
          body: formData,
        });
        if (uploadRes.ok) {
          const data = await uploadRes.json();
          usableRemote = data.url;
          usableLocal = data.local_path || usableLocal;
        } else {
          alert("ä¸Šä¼ è‡³å¿«æ·è®¿é—®å¤±è´¥");
          return;
        }
      } catch (e) {
        console.error("QuickAccess upload error:", e);
        alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
        return;
      }
    }

    images.push({
      localPath: usableLocal,
      remoteUrl: usableRemote,
      addedAt: new Date().toISOString(),
      tag: "å…¨éƒ¨",
      title: "", // â† æ–°å¢
    });
    save();
    renderSidebar();
  }

  function setTitle(index, newTitle) {
    if (images[index]) {
      images[index].title = (newTitle || "").trim();
      save();
      renderSidebar();
    }
  }

  function setTag(index, newTag) {
    if (images[index]) {
      images[index].tag = newTag;
      save();
      renderSidebar();
    }
  }

  function removeImage(index) {
    images.splice(index, 1);
    save();
    renderSidebar();
  }

  function setFilter(filter) {
    currentFilter = filter;
    renderSidebar();
  }

  // ===== æ–°å¢ï¼šæ˜¾ç¤ºæ·»åŠ /ç¼–è¾‘å¼¹çª— =====
  function showAddQuickAccessModal(imgData = null) {
    // imgData ç”¨äºç¼–è¾‘å·²æœ‰é¡¹
    const isEditing = !!imgData;
    const category = imgData?.category || "none";
    const group = imgData?.group || "";
    const viewType = imgData?.viewType || "";
    const note = imgData?.note || "";

    const modalId = "quickAccessDetailModal";
    let html = `
    <div class="modal fade" id="${modalId}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title">${isEditing ? "å›¾ç‰‡ä¿¡æ¯" : "å›¾ç‰‡ä¿¡æ¯"}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- åˆ†ç±»é€‰æ‹© -->
            <div class="mb-3">
              <label class="form-label">åˆ†ç±»</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="qaCategory" id="qaNone" value="none" ${category === "none" ? "checked" : ""}>
                <label class="form-check-label" for="qaNone">ä¸åˆ†ç±»</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="qaCategory" id="qaChar" value="è§’è‰²" ${category === "è§’è‰²" ? "checked" : ""}>
                <label class="form-check-label" for="qaChar">è§’è‰²</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="qaCategory" id="qaScene" value="åœºæ™¯" ${category === "åœºæ™¯" ? "checked" : ""}>
                <label class="form-check-label" for="qaScene">åœºæ™¯</label>
              </div>
            </div>

            <!-- åŠ¨æ€å­—æ®µå®¹å™¨ -->
            <div id="qaDynamicFields"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="qaSaveBtn">${isEditing ? "ä¿å­˜" : "æ·»åŠ "}</button>
          </div>
        </div>
      </div>
    </div>
    `;
    // æ›¿æ¢åŸåˆå§‹åŒ–ä»£ç 
    $("#quickAccessWindow").append(html);

    const modalEl = document.getElementById(modalId);
    if (!modalEl) {
      console.log("not modal");
      return;
    }

    // âœ… å…³é”®ä¿®å¤ï¼šé€šè¿‡ data attribute è®¾ç½® backdrop
    modalEl.setAttribute("data-bs-backdrop", "false");
    modalEl.setAttribute("data-bs-keyboard", "true"); // å¯é€‰

    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    // åŠ¨æ€æ¸²æŸ“å­—æ®µ
    function renderDynamicFields() {
      const cat = $('input[name="qaCategory"]:checked').val();
      let fieldsHtml = "";

      if (cat === "none") {
        fieldsHtml = `
          <div class="mb-3">
            <label class="form-label">æ ‡é¢˜</label>
            <input type="text" class="form-control" id="qaTitle" value="${group}">
          </div>
        `;
      } else {
        // æ”¶é›†å·²æœ‰çš„ group åå­—ï¼ˆå»é‡ï¼‰
        const existingGroups = [
          ...new Set(
            images
              .filter((img) => img.category === cat)
              .map((img) => img.group)
              .filter((g) => g && typeof g === "string"),
          ),
        ].sort();

        // æ„å»ºé€‰é¡¹
        let optionsHtml = `<option value="">ï¼ˆè¯·é€‰æ‹©æˆ–è¾“å…¥æ–°åå­—ï¼‰</option>`;
        existingGroups.forEach((g) => {
          const selected = g === group ? "selected" : "";
          optionsHtml += `<option value="${g}" ${selected}>${g}</option>`;
        });
        optionsHtml += `<option value="__new__" ${group && !existingGroups.includes(group) ? "selected" : ""}>å…¶ä»–ï¼ˆè¯·è¾“å…¥ï¼‰â€¦</option>`;

        const label = cat === "è§’è‰²" ? "è§’è‰²åå­—" : "åœºæ™¯åå­—";
        fieldsHtml += `
          <div class="mb-3">
            <label class="form-label">${label}</label>
            <select class="form-select" id="qaGroupSelect">
              ${optionsHtml}
            </select>
            <input type="text" class="form-control mt-1 d-none" id="qaGroupInput" placeholder="è¾“å…¥æ–°åå­—â€¦" value="${group && !existingGroups.includes(group) ? group : ""}">
          </div>
        `;

        // è§†è§’ä¸‹æ‹‰
        const charViews = [
          { value: "front_full", label: "æ­£é¢å…¨èº«" },
          { value: "side_full", label: "ä¾§é¢å…¨èº«" },
          { value: "back_full", label: "èƒŒé¢å…¨èº«" },
          { value: "face_closeup", label: "é¢éƒ¨ç‰¹å†™" },
        ];
        const sceneViews = [
          { value: "wide_shot", label: "å…¨æ™¯" },
          { value: "medium_shot", label: "è¿‘æ™¯" },
          { value: "birdseye", label: "ä¿¯è§†" },
          { value: "wormseye", label: "ä»°è§†" },
        ];
        const views = cat === "è§’è‰²" ? charViews : sceneViews;
        fieldsHtml += `
          <div class="mb-3">
            <label class="form-label">è§†è§’</label>
            <select class="form-select" id="qaViewType">
              <option value="">ï¼ˆå¯é€‰ï¼‰</option>
              ${views.map((v) => `<option value="${v.value}" ${viewType === v.value ? "selected" : ""}>${v.label}</option>`).join("")}
            </select>
          </div>
        `;

        // å¤‡æ³¨
        fieldsHtml += `
          <div class="mb-3">
            <label class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" class="form-control" id="qaNote" placeholder="å¦‚ï¼šæ ¡æœã€é›¨å¤©" value="${note}">
          </div>
        `;
      }

      $("#qaDynamicFields").html(fieldsHtml);

      // åˆ‡æ¢â€œå…¶ä»–â€¦â€æ—¶æ˜¾ç¤ºè¾“å…¥æ¡†
      $("#qaGroupSelect")
        .off("change")
        .on("change", function () {
          const val = $(this).val();
          if (val === "__new__") {
            $("#qaGroupInput").removeClass("d-none").focus();
          } else {
            $("#qaGroupInput").addClass("d-none");
          }
        });
    }

    // åˆå§‹æ¸²æŸ“
    renderDynamicFields();
    $('input[name="qaCategory"]').on("change", renderDynamicFields);

    // ä¿å­˜é€»è¾‘
    $("#qaSaveBtn").on("click", async () => {
      const cat = $('input[name="qaCategory"]:checked').val();
      let newImage = null;
      if (cat === "none") {
        const title = $("#qaTitle").val().trim();
        if (!title) {
          showToast("æ ‡é¢˜ä¸èƒ½ä¸ºç©º", "warning");
          return;
        }
        newImage = {
          category: null,
          group: title, // è€ title å…¼å®¹å­—æ®µ
          viewType: null,
          note: null,
          ...(imgData
            ? {
                localPath: imgData.localPath,
                remoteUrl: imgData.remoteUrl,
                addedAt: imgData.addedAt,
              }
            : {}),
        };
      } else {
        let group;
        const selectVal = $("#qaGroupSelect").val();
        if (selectVal === "__new__") {
          group = $("#qaGroupInput").val().trim();
        } else {
          group = selectVal;
        }
        if (!group) {
          showToast(`${cat}åå­—ä¸èƒ½ä¸ºç©º`, "warning");
          return;
        }
        newImage = {
          category: cat,
          group: group,
          viewType: $("#qaViewType").val() || null,
          note: $("#qaNote").val().trim() || null,
          ...(imgData
            ? {
                localPath: imgData.localPath,
                remoteUrl: imgData.remoteUrl,
                addedAt: imgData.addedAt,
              }
            : {}),
        };
      }

      if (!isEditing) {
        // æ–°å¢ï¼šéœ€ä¼ å…¥å›¾ç‰‡è·¯å¾„
        if (!window.__currentQuickAddImage) {
          showToast("å›¾ç‰‡ä¿¡æ¯ç¼ºå¤±", "error");
          return;
        }
        newImage.localPath = window.__currentQuickAddImage.localPath;
        newImage.remoteUrl = window.__currentQuickAddImage.remoteUrl;
        newImage.addedAt = new Date().toISOString();
        images.push(newImage);
      } else {
        // ç¼–è¾‘ï¼šæ›¿æ¢åŸæ•°æ®
        const idx = images.findIndex(
          (i) =>
            i.localPath === imgData.localPath &&
            i.remoteUrl === imgData.remoteUrl,
        );
        if (idx !== -1) images[idx] = newImage;
      }

      save();
      renderSidebar();
      modal.hide();
    });

    // åˆ é™¤ï¼ˆä»…ç¼–è¾‘æ—¶ï¼‰
    if (isEditing) {
      $("#qaDeleteBtn").on("click", () => {
        if (confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
          const idx = images.findIndex(
            (i) =>
              i.localPath === imgData.localPath &&
              i.remoteUrl === imgData.remoteUrl,
          );
          if (idx !== -1) images.splice(idx, 1);
          save();
          renderSidebar();
          modal.hide();
        }
      });
    }

    // è‡ªåŠ¨æ¸…ç†
    $(`#${modalId}`).on("hidden.bs.modal", () => $(`#${modalId}`).remove());
  }

  // è¾…åŠ©å‡½æ•°
  function getViewTypeLabel(key) {
    const map = {
      front_full: "æ­£é¢å…¨èº«",
      side_full: "ä¾§é¢å…¨èº«",
      back_full: "èƒŒé¢å…¨èº«",
      face_closeup: "é¢éƒ¨ç‰¹å†™",
      wide_shot: "å…¨æ™¯",
      medium_shot: "è¿‘æ™¯",
      birdseye: "ä¿¯è§†",
      wormseye: "ä»°è§†",
    };
    return map[key] || "";
  }

  function buildQuickImgItem(img, title) {
    const originalIndex = images.findIndex(
      (i) => i.localPath === img.localPath && i.remoteUrl === img.remoteUrl,
    );
    const titleDisplay = title
      ? `<div class="quick-img-title text-center small text-white bg-black bg-opacity-50 px-1" style="position:absolute;bottom:0;left:0;right:0;">${title}</div>`
      : "";
    return `
    <div class="quick-img-item position-relative border rounded d-flex justify-content-center align-items-center"
         style="width:120px;height:120px;cursor:pointer;" title="${title || "ç‚¹å‡»åŠ å…¥å‚è€ƒå›¾"}">
      <img draggable="true" src="${img.localPath || img.remoteUrl}" style="width:100%;height:100%;object-fit:contain;">
      ${titleDisplay}
      <div class="dropdown" style="position:absolute;top:-8px;right:-8px;">
        <button class="btn btn-sm btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" style="width:20px;height:20px;padding:0;font-size:10px;line-height:1;">â‹®</button>
        <ul class="dropdown-menu p-1" style="font-size:12px;">
          <li><a class="dropdown-item quick-title-btn" href="#" data-index="${originalIndex}">ç¼–è¾‘è¯¦æƒ…</a></li>
          <li><a class="dropdown-item text-danger quick-delete-btn" href="#" data-index="${originalIndex}">åˆ é™¤</a></li>
        </ul>
      </div>
    </div>
    `;
  }

  function renderSidebar(
    containerSelector = "#quickAccessWindow .quick-images-container",
  ) {
    const $container = $(containerSelector);
    if ($container.length === 0) return;

    let $renderTarget;

    // â€”â€”â€”â€”â€”â€” 1. ç¡®å®šæ¸²æŸ“ç›®æ ‡å®¹å™¨ â€”â€”â€”â€”â€”â€”
    $container.empty();
    $renderTarget = $container;

    // â€”â€”â€”â€”â€”â€” 2. æ¸²æŸ“è¿‡æ»¤å™¨ â€”â€”â€”â€”â€”â€”

    let $filter = $renderTarget.find(".quick-filter");
    if ($filter.length === 0) {
      $filter = $(`
          <div class="quick-filter d-flex gap-2 mb-2">
            <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" data-filter="all">å…¨éƒ¨</button>
            <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" data-filter="è§’è‰²">è§’è‰²</button>
            <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" data-filter="åœºæ™¯">åœºæ™¯</button>
          </div>
        `);
      $renderTarget.append($filter);
      $filter.on("click", ".filter-btn", function () {
        const filter = $(this).data("filter");
        setFilter(filter);
        // $filter.find(".filter-btn").removeClass("active");
        // $(this).addClass("active");
      });
      $filter
        .find(`.filter-btn[data-filter="${currentFilter}"]`)
        .addClass("active");
    }

    // â€”â€”â€”â€”â€”â€” 3. æ„å»ºå›¾åƒ HTML â€”â€”â€”â€”â€”â€”
    // è¿‡æ»¤å›¾ç‰‡
    const filteredImages =
      currentFilter === "all"
        ? images
        : images.filter((img) => img.category === currentFilter);

    // æ›¿æ¢åŸ $container.html(html) éƒ¨åˆ†
    // å…ˆåˆ†ç±»
    const byCategory = {
      è§’è‰²: {},
      åœºæ™¯: {},
      æœªåˆ†ç±»: [],
    };

    filteredImages.forEach((img) => {
      if (img.category === "è§’è‰²") {
        if (!byCategory["è§’è‰²"][img.group]) byCategory["è§’è‰²"][img.group] = [];
        byCategory["è§’è‰²"][img.group].push(img);
      } else if (img.category === "åœºæ™¯") {
        if (!byCategory["åœºæ™¯"][img.group]) byCategory["åœºæ™¯"][img.group] = [];
        byCategory["åœºæ™¯"][img.group].push(img);
      } else {
        byCategory["æœªåˆ†ç±»"].push(img);
      }
    });

    let html = "";

    // æ¸²æŸ“è§’è‰²
    for (const [group, imgs] of Object.entries(byCategory["è§’è‰²"])) {
      html += `
            <div class="quick-group">
              <h6 class="text-white mt-3 mb-1">${group}</h6>
              <div class="d-flex flex-wrap gap-2">
          `;
      imgs.forEach((img) => {
        const title =
          getViewTypeLabel(img.viewType) + (img.note ? `ï¼ˆ${img.note}ï¼‰` : "");
        html += buildQuickImgItem(img, title);
      });
      html += `</div></div>`;
    }

    // æ¸²æŸ“åœºæ™¯
    for (const [group, imgs] of Object.entries(byCategory["åœºæ™¯"])) {
      html += `
            <div class="quick-group">
              <h6 class="text-white mt-3 mb-1">${group}</h6>
              <div class="d-flex flex-wrap gap-2">
          `;
      imgs.forEach((img) => {
        const title =
          getViewTypeLabel(img.viewType) + (img.note ? `ï¼ˆ${img.note}ï¼‰` : "");
        html += buildQuickImgItem(img, title);
      });
      html += `</div></div>`;
    }

    // æ¸²æŸ“æœªåˆ†ç±»
    if (byCategory["æœªåˆ†ç±»"].length > 0) {
      html += `
            <div class="quick-group">
              <h6 class="text-white mt-3 mb-1 text-secondary">æœªåˆ†ç±»</h6>
              <div class="d-flex flex-wrap gap-2">
          `;
      byCategory["æœªåˆ†ç±»"].forEach((img) => {
        const title = img.group || "";
        html += buildQuickImgItem(img, title);
      });
      html += `</div></div>`;
    }

    // â€”â€”â€”â€”â€”â€” 4. æ’å…¥ HTML â€”â€”â€”â€”â€”â€”
    // $renderTarget.html(html);
    $renderTarget.append($(html));

    // â€”â€”â€”â€”â€”â€” 5. ç»‘å®šäº¤äº’äº‹ä»¶ â€”â€”â€”â€”â€”â€”
    const $target = $renderTarget;

    // ç‚¹å‡»é¢„è§ˆ
    // é‡æ–°ç»‘å®šäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
    $target.off("click").on("click", ".quick-img-item", function (e) {
      if ($(e.target).closest(".dropdown").length) return;

      const $img = $(this).find("img");
      const src = $img.attr("src");
      const img = images.find((i) => (i.localPath || i.remoteUrl) === src);

      if (!img) return;

      // æ„é€  fake itemï¼Œå…¼å®¹ showHistoryDetailModal
      const fakeItem = {
        id: "quick-" + Date.now(), // æ— çœŸå® IDï¼Œä½†ç”¨äºå”¯ä¸€æ ‡è¯†
        result_paths: [img.localPath || ""],
        result_urls: [img.remoteUrl || ""],
        input_paths: [],
        input_urls: [],
        timestamp: img.addedAt || new Date().toISOString(),
        params: {
          prompt: "(æ¥è‡ªå¿«æ·è®¿é—®)",
          size: "2K",
          aspect_ratio: "auto",
        },
      };

      // è°ƒç”¨å…¨å±€æ¨¡æ€æ¡†å‡½æ•°ï¼ˆéœ€ç¡®ä¿æ­¤å‡½æ•°åœ¨ window ä½œç”¨åŸŸæˆ–å¯è®¿é—®ï¼‰
      if (typeof window.showHistoryDetailModal === "function") {
        window.showHistoryDetailModal(fakeItem);
      } else {
        // å…œåº•ï¼šç›´æ¥åŠ å‚è€ƒå›¾ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
        const success = window.AIImageState?.addFromQuickAccess(
          img.localPath,
          img.remoteUrl,
        );
        if (success && window.UploadModule?.renderPreview) {
          window.UploadModule.renderPreview();
        }
      }
    });

    $target
      .off("dragstart")
      .on("dragstart", ".quick-img-item img", function (e) {
        const $img = $(this);
        const src = $img.attr("src");
        const img = images.find((i) => (i.localPath || i.remoteUrl) === src);
        if (!img) return;

        const itemData = {
          localPath: img.localPath,
          remoteUrl: img.remoteUrl,
        };
        window.__draggedItem = itemData;
        window.__dragOrigin = "quick"; // æ ‡è®°æ¥æºæ˜¯å¿«æ·æ 

        const originalEvent = e.originalEvent;
        const ghost = this.cloneNode(true);
        ghost.style.width = "100px";
        ghost.style.height = "100px";
        ghost.style.opacity = "0.9";
        ghost.style.borderRadius = "4px";
        ghost.style.objectFit = "contain";
        ghost.style.pointerEvents = "none";
        const ghostDiv = document.createElement("div");
        ghostDiv.appendChild(ghost);
        ghostDiv.style.position = "absolute";
        ghostDiv.style.top = "-9999px";
        document.body.appendChild(ghostDiv);

        originalEvent.dataTransfer.setDragImage(ghostDiv, 40, 40);

        const cleanup = () => {
          if (ghostDiv.parentNode) ghostDiv.parentNode.removeChild(ghostDiv);
          document.removeEventListener("dragend", cleanup);
        };
        document.addEventListener("dragend", cleanup);

        // å»¶è¿Ÿæ˜¾ç¤ºæ‹–æ‹½ç›®æ ‡ï¼Œä½†æ’é™¤â€œå¿«æ·è®¿é—®â€åŒºåŸŸ
        setTimeout(() => {
          $("#dragTargetOverlay").show();
          // éšè—å¿«æ·è®¿é—®ç›®æ ‡å›¾æ ‡ï¼ˆå¦‚æœæ˜¯ä»å¿«æ·æ æ‹–å‡ºï¼‰
          if (window.__dragOrigin === "quick") {
            $(`.drag-target-item[data-target="quick"]`).hide();
          }
        }, 100);
      });

    // æ ‡ç­¾è®¾ç½®
    $target
      .off("click", ".quick-tag-btn")
      .on("click", ".quick-tag-btn", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const index = $(this).data("index");
        const tag = $(this).data("tag");
        setTag(index, tag);
      });

    // è®¾ç½®æ ‡é¢˜
    // æ›¿æ¢åŸ .quick-title-btn é€»è¾‘
    $target
      .off("click", ".quick-title-btn")
      .on("click", ".quick-title-btn", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const index = $(this).data("index");
        const img = images[index];
        if (img) {
          showAddQuickAccessModal(img); // â† æ”¹ä¸ºç¼–è¾‘æ¨¡å¼
        }
      });

    // åˆ é™¤
    $target
      .off("click", ".quick-delete-btn")
      .on("click", ".quick-delete-btn", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const index = $(this).data("index");
        removeImage(index);
      });

    // åˆå§‹åŒ– Bootstrap dropdownï¼ˆå¦‚æœæœªè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
    if (typeof bootstrap !== "undefined" && bootstrap.Dropdown) {
      $target.find('[data-bs-toggle="dropdown"]').each(function () {
        new bootstrap.Dropdown(this);
      });
    }
  }

  load();
  return {
    addImage,
    renderSidebar,
    getImages: () => [...images],
  };
})();
