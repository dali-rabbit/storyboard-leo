---------------------
app.py å†…å®¹å¦‚ä¸‹
--------------------
import base64
import copy
import json
import os
import shutil
import tempfile
import uuid
from datetime import datetime
from io import BytesIO
from pathlib import Path
from threading import Lock

import requests
from dotenv import load_dotenv
from flask import Flask, jsonify, render_template, request, send_from_directory
from PIL import Image

from plugins import get_face_swap_plugin
from test_gen_api import generate_via_image_fallback
from uploader import UploadError, upload_file

load_dotenv()

IMGBB_API_KEY = os.getenv("IMGBB_API_KEY")
SESSION_KEY = os.getenv("SESSION_KEY")


# é…ç½®
HISTORY_DIR = Path("history")
HISTORY_DIR.mkdir(exist_ok=True)

# é¿å…é‡å¤æäº¤ï¼ˆç®€å•ä»»åŠ¡é”ï¼‰
current_task_lock = Lock()
is_generating = False

# ä¿å­˜è¾“å…¥å›¾ç‰‡
INPUT_IMAGES_DIR = HISTORY_DIR / "inputs"
INPUT_IMAGES_DIR.mkdir(parents=True, exist_ok=True)


# ä¿å­˜ç”Ÿæˆç»“æœ
RESULTS_DIR = HISTORY_DIR / "results"
RESULTS_DIR.mkdir(exist_ok=True)


app = Flask(__name__)
app.secret_key = SESSION_KEY  # ç”¨äº session å®‰å…¨


def save_image_from_url(url: str, folder: Path) -> str:
    """ä» URL ä¸‹è½½å›¾ç‰‡ï¼Œä¿å­˜åˆ° folderï¼Œè¿”å›æœ¬åœ°ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ 'results/abc.jpg'ï¼‰"""
    try:
        resp = requests.get(url, stream=True, timeout=30)
        if resp.status_code != 200:
            raise Exception(f"HTTP {resp.status_code}")

        # æ¨æµ‹æ–‡ä»¶æ‰©å±•å
        ext = ".jpg"  # é»˜è®¤ç”¨ jpg
        content_type = resp.headers.get("content-type", "")
        if "png" in content_type:
            ext = ".png"
        elif "webp" in content_type:
            ext = ".webp"

        filename = str(uuid.uuid4()) + ext
        filepath = folder / filename

        with open(filepath, "wb") as f:
            resp.raw.decode_content = True
            shutil.copyfileobj(resp.raw, f)

        # å¼ºåˆ¶è½¬ä¸º JPGï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
        if ext != ".jpg":
            from PIL import Image

            img = Image.open(filepath).convert("RGB")
            jpg_path = filepath.with_suffix(".jpg")
            img.save(jpg_path, "JPEG", quality=92)
            filepath.unlink()  # åˆ é™¤åŸæ–‡ä»¶
            filepath = jpg_path

        return str(filepath.relative_to(Path(".")))  # å¦‚ "history/inputs/xxx.jpg"
    except Exception as e:
        print(f"[Save Image Error] {url} -> {e}")
        return None


def save_uploaded_file_as_jpg(file_storage, folder: Path) -> str:
    """å°† Flask ä¸Šä¼ çš„ file ä¿å­˜ä¸º JPGï¼ˆPNG è‡ªåŠ¨è½¬ï¼‰"""
    try:
        filename = str(uuid.uuid4()) + ".jpg"
        temp_path = folder / filename

        # è‹¥æ˜¯ PNGï¼Œç”¨ PIL è½¬ JPGï¼ˆå¸¦ç™½åº•ï¼‰
        if file_storage.filename.lower().endswith(".png"):
            from PIL import Image

            img = Image.open(file_storage.stream).convert("RGBA")
            background = Image.new("RGB", img.size, (255, 255, 255))
            background.paste(img, mask=img.split()[-1] if img.mode == "RGBA" else None)
            background.save(temp_path, "JPEG", quality=92)
        else:
            # ç›´æ¥ä¿å­˜ä¸º JPGï¼ˆå³ä½¿åŸä¸º JPG/JPEGï¼‰
            from PIL import Image

            img = Image.open(file_storage.stream).convert("RGB")
            img.save(temp_path, "JPEG", quality=92)

        return str(temp_path.relative_to(Path(".")))
    except Exception as e:
        print(f"[Save Uploaded File Error] {e}")
        return None


@app.route("/history/<path:filename>")
def history_files(filename):
    return send_from_directory(HISTORY_DIR, filename)


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/upload-images", methods=["POST"])
def upload_images():
    files = request.files.getlist("images")
    if not files:
        return jsonify({"error": "No images provided"}), 400

    external_urls = []
    local_paths = []

    for file in files[:10]:
        if not file.filename.lower().endswith((".png", ".jpg", ".jpeg", ".webp")):
            continue

        # 1. ä¿å­˜æœ¬åœ° JPG å‰¯æœ¬ï¼ˆç”¨äºå†å²è®°å½•ï¼‰
        file.stream.seek(0)
        local_path = save_uploaded_file_as_jpg(file, INPUT_IMAGES_DIR)
        if not local_path:
            continue
        local_paths.append("/" + local_path.replace("\\", "/"))

        # 2. ä¸Šä¼ åˆ°å¤–éƒ¨æœåŠ¡ï¼ˆImgBB æˆ– GitHub+jsDelivrï¼‰
        try:
            # ä¸´æ—¶ä¿å­˜æ–‡ä»¶ç”¨äºä¸Šä¼ 
            with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as tmp:
                tmp_path = tmp.name
                with open(local_path, "rb") as src:
                    tmp.write(src.read())
            # ä¸Šä¼ 
            external_url = upload_file(tmp_path, file.filename)
            external_urls.append(external_url)
        except Exception as e:
            print(f"[Upload External Error] {e}")
            external_urls.append(None)
        finally:
            if "tmp_path" in locals():
                Path(tmp_path).unlink(missing_ok=True)

    # è¿‡æ»¤æ‰ä¸Šä¼ å¤±è´¥çš„
    valid_records = [
        (url, local) for url, local in zip(external_urls, local_paths) if url
    ]
    if not valid_records:
        return jsonify({"error": "All uploads failed"}), 500

    external_urls, local_paths = zip(*valid_records)
    return jsonify({"urls": list(external_urls), "local_paths": list(local_paths)})


@app.route("/generate", methods=["POST"])
def generate():
    global is_generating
    if current_task_lock.locked():
        return jsonify({"error": "Another task is running. Please wait."}), 429

    with current_task_lock:
        data = request.get_json()
        image_urls = data.get("image_urls", [])  # â† è¿™æ˜¯ ImgBB URLsï¼Œæ­£ç¡®ï¼
        prompt = data.get("prompt", "").strip()
        size = data.get("size", "2K")
        aspect_ratio = data.get("aspect_ratio", "auto")

        if not prompt:
            return jsonify({"error": "Prompt is required"}), 400

        try:
            result_urls = generate_via_image_fallback(
                image_urls=image_urls,
                prompt=prompt,
                size=size,
                ar=aspect_ratio,
                fallback_order=["nano_banana", "rh_official"],
            )
        except Exception as e:
            return jsonify({"error": f"Generation failed: {str(e)}"}), 500

        if not result_urls:
            return jsonify({"error": "All APIs failed to generate image"}), 500

        # âœ… ä¿å­˜ç»“æœå›¾åˆ°æœ¬åœ°ï¼ˆä» result_urls ä¸‹è½½ï¼‰
        local_result_paths = []
        for url in result_urls:
            local_path = save_image_from_url(url, RESULTS_DIR)
            if local_path:
                local_result_paths.append("/" + local_path.replace("\\", "/"))

        if not local_result_paths:
            return jsonify({"error": "Failed to save result images locally"}), 500

        # âœ… è·å–å¯¹åº”çš„æœ¬åœ°è¾“å…¥å›¾è·¯å¾„ï¼ˆç”¨äºå†å²è®°å½•å±•ç¤ºï¼‰
        # å‡è®¾å‰ç«¯ä¼ çš„ image_urls é¡ºåºå’Œæœ¬åœ°ä¿å­˜ä¸€è‡´ â€”â€” ä½†æ›´å¯é çš„æ–¹å¼æ˜¯å‰ç«¯ä¼  local_pathsï¼Ÿ
        # ç®€åŒ–æ–¹æ¡ˆï¼šæˆ‘ä»¬ä»å†å²ä¸­åŒ¹é…ï¼ˆä¸å®Œç¾ï¼‰ï¼Œæˆ–è®©å‰ç«¯åŒæ—¶ä¼  local_input_paths
        # â†’ æ›´å¥½çš„åšæ³•ï¼šå‰ç«¯åœ¨ generate æ—¶åŒæ—¶ä¼  local_input_paths

        # ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬æš‚ä¸ä¿å­˜è¾“å…¥å›¾æœ¬åœ°è·¯å¾„åˆ° recordï¼ˆæˆ–ä»å·²æœ‰æ–‡ä»¶æ¨æ–­ï¼‰
        # å®é™…ä¸Šï¼Œä½ å¯ä»¥é€šè¿‡ image_urls çš„æ–‡ä»¶ååæ¨ï¼Œä½†ç•¥å¤æ‚
        # å»ºè®®ï¼šå‰ç«¯åœ¨ /generate æ—¶é¢å¤–ä¼  `local_input_paths`

        local_input_paths = data.get("local_input_paths", [])

        record_id = str(uuid.uuid4())
        record = {
            "id": record_id,
            "timestamp": datetime.now().isoformat(),
            "image_urls": image_urls,  # å¤–éƒ¨ URLï¼ˆç”¨äºè°ƒè¯•ï¼‰
            "local_input_paths": local_input_paths,
            "result_urls": result_urls,  # å¤–éƒ¨ URL
            "local_result_paths": local_result_paths,  # æœ¬åœ°è·¯å¾„
            "prompt": prompt,
            "size": size,
            "aspect_ratio": aspect_ratio,
        }

        record_path = HISTORY_DIR / f"{record_id}.json"
        with open(record_path, "w", encoding="utf-8") as f:
            json.dump(record, f, ensure_ascii=False, indent=2)

        # è¿”å›æœ¬åœ°è·¯å¾„ç»™å‰ç«¯å±•ç¤º
        return jsonify(
            {
                "success": True,
                "result_urls": local_result_paths,  # å‰ç«¯ç”¨æœ¬åœ°è·¯å¾„æ˜¾ç¤º
                "record_id": record_id,
            }
        )


@app.route("/history")
def get_history():
    """åˆ†é¡µè·å–å†å²è®°å½•ï¼ˆJSON æ–‡ä»¶åˆ—è¡¨ï¼‰"""
    page = int(request.args.get("page", 1))
    limit = int(request.args.get("limit", 12))
    if page < 1:
        page = 1

    # è·å–æ‰€æœ‰ JSON æ–‡ä»¶ï¼ŒæŒ‰æ—¶é—´å€’åº
    history_files = sorted(
        HISTORY_DIR.glob("*.json"), key=os.path.getmtime, reverse=True
    )

    total = len(history_files)
    start = (page - 1) * limit
    end = start + limit
    page_files = history_files[start:end]

    records = []
    for f in page_files:
        try:
            with open(f, "r", encoding="utf-8") as fp:
                record = json.load(fp)
                # åªè¿”å›å¿…è¦å­—æ®µç»™å‰ç«¯
                records.append(
                    {
                        "id": record["id"],
                        "timestamp": record["timestamp"],
                        "result_paths": record.get("local_result_paths", []),
                        "result_urls": record.get("result_urls", []),
                        "input_paths": record.get("local_input_paths", []),
                        "input_urls": record.get("image_urls", []),
                        "params": {
                            "size": record["size"],
                            "aspect_ratio": record["aspect_ratio"],
                            "prompt": record["prompt"],
                        },
                    }
                )
        except Exception as e:
            print(f"[History] Load error: {f} - {e}")
            continue

    return jsonify(
        {
            "records": records,
            "total": total,
            "page": page,
            "limit": limit,
            "pages": (total + limit - 1) // limit,
        }
    )


@app.route("/quick-upload", methods=["POST"])
def quick_upload():
    file = request.files.get("file")
    if not file or not file.filename:
        return jsonify({"error": "No file"}), 400

    local_path = save_uploaded_file_as_jpg(file, INPUT_IMAGES_DIR)
    if not local_path:
        return jsonify({"error": "Save failed"}), 500

    try:
        external_url = upload_file(local_path, file.filename)
        return jsonify(
            {
                "url": external_url,
                "local_path": "/" + local_path.replace("\\", "/"),
            }
        )
    except Exception as e:
        print(f"[Quick Upload Error] {e}")
        return jsonify({"error": "External upload failed"}), 500


@app.route("/save-cropped-images", methods=["POST"])
def save_cropped_images():
    """æ¥æ”¶ Base64 å›¾ç‰‡åˆ—è¡¨ï¼Œä¿å­˜åˆ° history/results/ï¼Œè¿”å›æœ¬åœ°è·¯å¾„"""
    data = request.get_json()
    base64_images = data.get("images", [])  # list of "data:image/jpeg;base64,..."

    if not base64_images:
        return jsonify({"error": "No images provided"}), 400

    saved_paths = []
    for b64_str in base64_images:
        try:
            # å»æ‰ data URL å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
            if b64_str.startswith("data:image"):
                header, b64_str = b64_str.split(",", 1)

            # è§£ç  Base64
            image_data = base64.b64decode(b64_str)
            image = Image.open(BytesIO(image_data)).convert("RGB")

            # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
            filename = f"{uuid.uuid4().hex}.jpg"
            filepath = RESULTS_DIR / filename
            image.save(filepath, "JPEG", quality=92)

            # è¿”å›ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„ï¼ˆå‰ç«¯å¯ç›´æ¥ /history/results/... è®¿é—®ï¼‰
            rel_path = f"/{filepath.relative_to(Path('.')).as_posix()}"
            saved_paths.append(rel_path)
        except Exception as e:
            print(f"[Save Cropped Image Error] {e}")
            continue

    return jsonify({"success": True, "local_paths": saved_paths})


@app.route("/history-record", methods=["POST"])
def save_manual_history():
    data = request.get_json()
    i = 1
    for local_result_path in data.get("local_result_paths", []):
        record_data = copy.deepcopy(data)
        record_data["local_result_paths"] = [local_result_path]
        record_id = data.get("id", str(uuid.uuid4()))
        record_path = HISTORY_DIR / f"{record_id}_{i}.json"
        with open(record_path, "w", encoding="utf-8") as f:
            json.dump(record_data, f, ensure_ascii=False, indent=2)
        i += 1
    return jsonify({"success": True})


@app.route("/history/<record_id>", methods=["DELETE"])
def delete_history_record(record_id):
    """åˆ é™¤æŒ‡å®šå†å²è®°å½•ï¼ˆJSON + æœ¬åœ°å›¾ç‰‡ï¼‰"""
    try:
        # 1. æ‰¾åˆ° JSON æ–‡ä»¶
        json_path = None
        for f in HISTORY_DIR.glob("*.json"):
            if f.stem.startswith(record_id):
                json_path = f
                break

        if not json_path:
            return jsonify({"error": "Record not found"}), 404

        # 2. è¯»å–è®°å½•ï¼Œè·å–æ‰€æœ‰æœ¬åœ°å›¾ç‰‡è·¯å¾„
        with open(json_path, "r", encoding="utf-8") as fp:
            record = json.load(fp)

        all_local_paths = []
        all_local_paths.extend(record.get("local_result_paths", []))

        # 3. åˆ é™¤ JSON æ–‡ä»¶
        json_path.unlink()

        # 4. åˆ é™¤å…³è”çš„æœ¬åœ°å›¾ç‰‡
        for rel_path in all_local_paths:
            if rel_path.startswith("/"):
                rel_path = rel_path[1:]
            full_path = Path(rel_path)
            if full_path.exists():
                full_path.unlink()

        return jsonify({"success": True})
    except Exception as e:
        print(f"[Delete Error] {e}")
        return jsonify({"error": "Delete failed"}), 500


# @app.route("/swap_face", methods=["POST"])
# def swap_face():
#     """
#     ä½¿ç”¨ generate_via_image_fallback å®ç°æ¢è„¸ï¼šå›¾1ä¸ºè¢«æ›¿æ¢å›¾åƒï¼Œå›¾2ä¸ºäººè„¸æºå›¾åƒã€‚
#     """
#     global is_generating
#     if current_task_lock.locked():
#         return jsonify({"error": "Another task is running. Please wait."}), 429

#     with current_task_lock:
#         try:
#             data = request.get_json()
#             source_url = data.get("source_url", "").strip()  # å›¾1ï¼šè¢«æ¢è„¸çš„å›¾
#             face_url = data.get("face_url", "").strip()  # å›¾2ï¼šæä¾›äººè„¸çš„å›¾

#             if not source_url or not face_url:
#                 return jsonify({"error": "Missing source_url or face_url"}), 400

#             # æ„é€ è¾“å…¥å›¾ç‰‡é¡ºåºï¼š[å›¾1, å›¾2]
#             image_urls = [source_url, face_url]

#             # ç²¾ç‚¼æç¤ºè¯ï¼šæ˜ç¡®æŒ‡ä»¤ + ä¿æŒå…¶ä»–ä¸å˜
#             prompt = "æˆ‘éœ€è¦æ‰§è¡Œä¸€ä¸ªæ¢è„¸ä»»åŠ¡ï¼Œtarget imageæ˜¯å›¾1ï¼Œface imageæ˜¯å›¾2"

#             # ä½¿ç”¨ç°æœ‰ç”Ÿæˆé€»è¾‘ï¼ˆauto é•¿å®½æ¯”ï¼Œ2K å°ºå¯¸ï¼‰
#             result_urls = generate_via_image_fallback(
#                 image_urls=image_urls,
#                 prompt=prompt,
#                 size="2K",
#                 ar="auto",
#                 fallback_order=["nano_banana", "rh_official"],
#             )

#             if not result_urls:
#                 return jsonify(
#                     {"error": "All APIs failed to generate swapped image"}
#                 ), 500

#             # ä¿å­˜ç»“æœåˆ°æœ¬åœ°
#             local_result_paths = []
#             for url in result_urls:
#                 local_path = save_image_from_url(url, RESULTS_DIR)
#                 if local_path:
#                     local_result_paths.append("/" + local_path.replace("\\", "/"))

#             if not local_result_paths:
#                 return jsonify({"error": "Failed to save result images locally"}), 500

#             # è¿”å›ç¬¬ä¸€ä¸ªç»“æœï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªï¼‰
#             return jsonify(
#                 {
#                     "success": True,
#                     "result_url": result_urls[0],  # åŸå§‹å¤–éƒ¨ URL
#                     "local_path": local_result_paths[0],  # æœ¬åœ°è·¯å¾„ä¾›å‰ç«¯æ˜¾ç¤º
#                 }
#             )

#         except Exception as e:
#             print(f"[Swap Face Error] {e}")
#             return jsonify({"error": f"æ¢è„¸å¤±è´¥: {str(e)}"}), 500


@app.route("/swap_face", methods=["POST"])
def swap_face():
    """
    è°ƒç”¨é…ç½®çš„æ¢è„¸æ’ä»¶ï¼ˆå¦‚ replicate_swapï¼‰ï¼Œæ‰§è¡ŒçœŸå®æ¢è„¸ã€‚
    """
    try:
        data = request.get_json()
        source_url = data.get("source_url", "").strip()
        face_url = data.get("face_url", "").strip()

        if not source_url or not face_url:
            return jsonify({"error": "Missing source_url or face_url"}), 400

        # è·å–æ¢è„¸æ’ä»¶å‡½æ•°
        swap_func = get_face_swap_plugin()
        if swap_func is None:
            return jsonify(
                {"error": "Face swap plugin not configured or unavailable"}
            ), 500

        # è°ƒç”¨æ’ä»¶æ‰§è¡Œæ¢è„¸
        result_url = swap_func(source_image_url=source_url, face_image_url=face_url)

        # ä¿å­˜ç»“æœåˆ°æœ¬åœ°ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
        local_path = save_image_from_url(result_url, RESULTS_DIR)
        if not local_path:
            return jsonify({"error": "Failed to save swapped image locally"}), 500

        return jsonify(
            {
                "success": True,
                "result_url": result_url,  # å¤–éƒ¨ URLï¼ˆè°ƒè¯•ç”¨ï¼‰
                "local_path": "/" + local_path.replace("\\", "/"),  # å‰ç«¯å±•ç¤ºç”¨
            }
        )

    except Exception as e:
        print(f"[Swap Face Error] {e}")
        return jsonify({"error": f"æ¢è„¸å¤±è´¥: {str(e)}"}), 500


@app.route("/dummy_swap_face", methods=["POST"])
def dummy_swap_face():
    """
    ä¼ªæ¢è„¸æ¥å£ï¼šæ¥æ”¶ source_url å’Œ face_urlï¼Œè¿”å›ä¸€ä¸ªå ä½ç»“æœå›¾
    """
    try:
        data = request.get_json()
        source_url = data.get("source_url")
        face_url = data.get("face_url")

        if not source_url or not face_url:
            return jsonify({"error": "Missing source_url or face_url"}), 400

        # âœ… ä¼ªé€»è¾‘ï¼šè¿”å›ä¸€ä¸ªå›ºå®šå ä½å›¾ï¼ˆå¯æ›¿æ¢ä¸ºçœŸå®æ¢è„¸ï¼‰
        result_url = "https://placehold.co/1280x800?text=FACE"

        # ï¼ˆå¯é€‰ï¼‰æœªæ¥æ›¿æ¢ä¸ºçœŸå®æ¢è„¸ï¼š
        # result_url = real_face_swap(source_url, face_url)

        return jsonify({"success": True, "result_url": result_url})

    except Exception as e:
        print(f"[Swap Face Error] {e}")
        return jsonify({"error": "æ¢è„¸å¤±è´¥"}), 500


# ç¡®ä¿ç›®å½•å­˜åœ¨
STORYBOARD_DIR = os.path.join(os.path.dirname(__file__), "storyboards")
os.makedirs(STORYBOARD_DIR, exist_ok=True)


@app.route("/save-storyboard", methods=["POST"])
def save_storyboard():
    data = request.json
    if "panels" not in data:
        return jsonify({"success": False, "error": "æ— æ•ˆæ•°æ®"})

    title = ""
    if "title" in data:
        title = data["title"]
    record_id = None
    if "id" in data:
        record_id = data["id"]

    # éªŒè¯ panels ç»“æ„
    for panel in data["panels"]:
        if not isinstance(panel.get("images"), list):
            return jsonify({"success": False, "error": "images å¿…é¡»æ˜¯æ•°ç»„"})
        for url in panel["images"]:
            if not isinstance(url, str) or not url.strip():
                return jsonify({"success": False, "error": "å›¾ç‰‡å¼•ç”¨å¿…é¡»æ˜¯æœ‰æ•ˆå­—ç¬¦ä¸²"})

    # å¦‚ä¸å­˜åœ¨è¾“å…¥idï¼Œåˆ™ä¸ºæ–°recordç”Ÿæˆå”¯ä¸€ ID
    if not record_id:
        record_id = (
            f"sb_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{str(uuid.uuid4())[:8]}"
        )

    record = {
        "title": title,
        "id": record_id,
        "type": "storyboard",
        "timestamp": datetime.utcnow().isoformat(),
        "panels": data["panels"],  # ä»…ä¿å­˜å¼•ç”¨è·¯å¾„
    }

    # ä¿å­˜ä¸ºå•ä¸ª JSON æ–‡ä»¶
    filepath = os.path.join(STORYBOARD_DIR, f"{record_id}.json")
    with open(filepath, "w", encoding="utf-8") as f:
        json.dump(record, f, ensure_ascii=False, indent=2)

    return jsonify({"success": True, "record_id": record_id})


@app.route("/list-storyboards", methods=["GET"])
def list_storyboards():
    files = []
    for f in os.listdir(STORYBOARD_DIR):
        if f.endswith(".json"):
            with open(os.path.join(STORYBOARD_DIR, f), "r", encoding="utf-8") as fp:
                try:
                    data = json.load(fp)
                    files.append(
                        {
                            "id": data.get("id"),
                            "title": data.get("title", "æœªå‘½åæ•…äº‹æ¿"),
                            "timestamp": data.get("timestamp"),
                        }
                    )
                except:
                    continue
    # æŒ‰æ—¶é—´å€’åº
    files.sort(key=lambda x: x["timestamp"], reverse=True)
    return jsonify(files)


@app.route("/load-storyboard/<id>", methods=["GET"])
def load_storyboard(id):
    filepath = os.path.join(STORYBOARD_DIR, f"{id}.json")
    if not os.path.exists(filepath):
        return jsonify({"error": "Not found"}), 404
    with open(filepath, "r", encoding="utf-8") as f:
        data = json.load(f)
    return jsonify(data)


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5001, debug=True)


---------------------
index.html å†…å®¹å¦‚ä¸‹
--------------------
<!-- æ·±è‰²ä¸»é¢˜ index.html -->
<!doctype html>
<html lang="zh-CN" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>åˆ†é•œç‹®</title>
        <link
            rel="icon"
            type="image/png"
            href="{{ url_for('static', filename='favicon-96x96.png') }}"
            sizes="96x96"
        />
        <link
            rel="icon"
            type="image/svg+xml"
            href="{{ url_for('static', filename='favicon.svg') }}"
        />
        <link
            rel="shortcut icon"
            href="{{ url_for('static', filename='favicon.ico') }}"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ url_for('static', filename='apple-touch-icon.png') }}"
        />
        <link
            rel="manifest"
            href="{{ url_for('static', filename='site.webmanifest') }}"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', filename='main.css') }}"
            rel="stylesheet"
        />
    </head>
    <body>
        <!-- å·¥å…·ä¾§è¾¹æ ï¼ˆå‚ç›´å°å›¾æ ‡ï¼‰ -->
        <div id="toolSidebar" class="tool-sidebar">
            <button
                class="btn btn-dark tool-btn"
                type="button"
                title="å¿«æ·è®¿é—®"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                data-target="quick-access"
            >
                â˜…
            </button>
            <button
                class="btn btn-dark tool-btn"
                type="button"
                title="å†å²è®°å½•"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                data-target="history-window"
            >
                ğŸ•’
            </button>
        </div>
        <div class="container my-4">
            <!-- æ ‡é¢˜ + æ ‡ç­¾ -->
            <div class="d-flex flex-column mb-4">
                <div
                    class="d-flex justify-content-between align-items-start mb-4"
                >
                    <h1 class="mb-0">ğŸ¦ åˆ†é•œç‹®</h1>
                    <!-- é¡¶éƒ¨æ ‡ç­¾ï¼ˆé€‰é¡¹å¡ï¼‰ -->
                    <ul class="nav nav-tabs ms-4" id="topTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link active"
                                id="quick-gen-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#quick-gen"
                                type="button"
                                role="tab"
                                aria-controls="quick-gen"
                                aria-selected="true"
                            >
                                å¿«é€Ÿç”Ÿå›¾
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="image-split-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#image-split"
                                type="button"
                                role="tab"
                                aria-controls="image-split"
                                aria-selected="false"
                            >
                                å›¾ç‰‡ç¼–è¾‘
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="storyboard-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#storyboard"
                                type="button"
                                role="tab"
                                aria-controls="storyboard"
                                aria-selected="false"
                            >
                                æ•…äº‹æ¿
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Tab å†…å®¹ -->
            <div class="tab-content" id="topTabsContent">
                <!-- Tab å†…å®¹åŒºåŸŸ -->
                <div class="tab-content" id="topTabsContent">
                    <!-- å¿«é€Ÿç”Ÿå›¾ï¼ˆå½“å‰é¡µé¢å†…å®¹ï¼‰ -->
                    <div
                        class="tab-pane fade show active"
                        id="quick-gen"
                        role="tabpanel"
                        aria-labelledby="quick-gen-tab"
                    >
                        <!-- åŸæœ‰çš„å·¦å³ä¸¤æ å¸ƒå±€ -->
                        <div class="row">
                            <!-- è¡¨å• -->
                            <div class="col-lg-6">
                                <!-- ä½ åŸæ¥çš„ä¸Šä¼ å’Œå‚æ•°å¡ç‰‡ -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        ä¸Šä¼ å‚è€ƒå›¾ï¼ˆæœ€å¤š10å¼ ï¼‰
                                    </div>
                                    <div class="card-body">
                                        <!-- éšè—åŸç”Ÿ input -->
                                        <input
                                            type="file"
                                            id="imageUpload"
                                            multiple
                                            accept="image/*"
                                            class="d-none"
                                        />

                                        <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                                        <div
                                            id="dropZone"
                                            class="dashed-upload text-center py-4 mb-2"
                                        >
                                            <div class="text-muted">
                                                ğŸ“ æ‹–æ‹½å›¾ç‰‡è‡³æ­¤ï¼Œæˆ–
                                                <u>ç‚¹å‡»ä¸Šä¼ </u>
                                            </div>
                                        </div>

                                        <!-- ä¸Šä¼ è¿›åº¦æ¡ï¼ˆåˆå§‹éšè—ï¼‰ -->
                                        <div
                                            id="uploadProgress"
                                            class="mt-2"
                                            style="display: none"
                                        >
                                            <div
                                                class="progress"
                                                style="height: 8px"
                                            >
                                                <div
                                                    class="progress-bar progress-bar-striped progress-bar-animated"
                                                    role="progressbar"
                                                    style="width: 0%"
                                                ></div>
                                            </div>
                                            <small class="text-muted"
                                                >ä¸Šä¼ ä¸­...</small
                                            >
                                        </div>

                                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                                        <ul
                                            id="uploadPreview"
                                            class="d-flex flex-wrap gap-2 p-0 m-0"
                                        ></ul>
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header">ç”Ÿæˆå‚æ•°</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label"
                                                >åˆ†è¾¨ç‡</label
                                            >
                                            <select
                                                id="resolution"
                                                class="form-select"
                                            >
                                                <option value="1K">1K</option>
                                                <option value="2K" selected>
                                                    2K
                                                </option>
                                                <option value="4K">4K</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                >é•¿å®½æ¯”</label
                                            >
                                            <select
                                                id="aspectRatio"
                                                class="form-select"
                                            >
                                                <option value="auto">
                                                    Auto
                                                </option>
                                                <option value="1:1">1:1</option>
                                                <option value="16:9">
                                                    16:9
                                                </option>
                                                <option value="9:16">
                                                    9:16
                                                </option>
                                                <option value="4:3">4:3</option>
                                                <option value="3:4">3:4</option>
                                                <option value="3:2">3:2</option>
                                                <option value="2:3">2:3</option>
                                                <option value="5:4">5:4</option>
                                                <option value="4:5">4:5</option>
                                                <option value="21:9">
                                                    21:9
                                                </option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                >æç¤ºè¯æ¨¡å¼</label
                                            >
                                            <div class="form-check">
                                                <input
                                                    class="form-check-input"
                                                    type="radio"
                                                    name="mode"
                                                    id="modeRaw"
                                                    value="raw"
                                                    checked
                                                />
                                                <label
                                                    class="form-check-label"
                                                    for="modeRaw"
                                                    >Raw æ¨¡å¼</label
                                                >
                                            </div>
                                            <div class="form-check">
                                                <input
                                                    class="form-check-input"
                                                    type="radio"
                                                    name="mode"
                                                    id="modeStoryboard"
                                                    value="storyboard"
                                                />
                                                <label
                                                    class="form-check-label"
                                                    for="modeStoryboard"
                                                    >åˆ†é•œæ¨¡å¼</label
                                                >
                                            </div>
                                            <div class="form-check">
                                                <input
                                                    class="form-check-input"
                                                    type="radio"
                                                    name="mode"
                                                    id="modeCharacter"
                                                    value="character"
                                                />
                                                <label
                                                    class="form-check-label"
                                                    for="modeCharacter"
                                                    >è§’è‰²æ¨¡å¼</label
                                                >
                                            </div>
                                        </div>

                                        <div id="rawSection">
                                            <textarea
                                                id="promptRaw"
                                                class="form-control"
                                                rows="4"
                                                placeholder="è¯·è¾“å…¥æç¤ºè¯..."
                                            ></textarea>
                                        </div>
                                        <div
                                            id="storyboardSection"
                                            style="display: none"
                                        >
                                            <input
                                                type="text"
                                                id="prePrompt"
                                                class="form-control mb-2"
                                                placeholder="å‰ææè¿°"
                                            />
                                            <input
                                                type="text"
                                                id="style"
                                                class="form-control mb-2"
                                                placeholder="é£æ ¼"
                                            />
                                            <textarea
                                                id="shot1"
                                                class="form-control mb-2"
                                                placeholder="åˆ†é•œä¸€"
                                            ></textarea>
                                            <textarea
                                                id="shot2"
                                                class="form-control mb-2"
                                                placeholder="åˆ†é•œäºŒ"
                                            ></textarea>
                                            <textarea
                                                id="shot3"
                                                class="form-control mb-2"
                                                placeholder="åˆ†é•œä¸‰"
                                            ></textarea>
                                            <textarea
                                                id="shot4"
                                                class="form-control"
                                                placeholder="åˆ†é•œå››"
                                            ></textarea>
                                        </div>
                                        <div
                                            id="characterSection"
                                            style="display: none"
                                        >
                                            <div class="mb-3">
                                                <label class="form-label"
                                                    >è§’è‰²è§†è§’ï¼ˆå¯å¤šé€‰ï¼‰</label
                                                >
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewFront"
                                                        value="æ­£é¢å…¨èº«"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewFront"
                                                        >æ­£é¢å…¨èº«</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewSide"
                                                        value="ä¾§é¢å…¨èº«"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewSide"
                                                        >ä¾§é¢å…¨èº«</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewBack"
                                                        value="èƒŒé¢å…¨èº«"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewBack"
                                                        >èƒŒé¢å…¨èº«</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewFace"
                                                        value="é¢éƒ¨ç‰¹å†™"
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewFace"
                                                        >é¢éƒ¨ç‰¹å†™</label
                                                    >
                                                </div>
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        id="viewSolidBg"
                                                        value="çº¯è‰²èƒŒæ™¯"
                                                        checked
                                                    />
                                                    <label
                                                        class="form-check-label"
                                                        for="viewSolidBg"
                                                        >çº¯è‰²èƒŒæ™¯</label
                                                    >
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label"
                                                    >å…¶ä»–è¯´æ˜ï¼ˆé£æ ¼/å§¿æ€ï¼‰</label
                                                >
                                                <textarea
                                                    id="characterNotes"
                                                    class="form-control"
                                                    rows="2"
                                                    placeholder="ä¾‹å¦‚ï¼šæ—¥ç³»äºŒæ¬¡å…ƒï¼Œç«™å§¿è‡ªç„¶ï¼Œè¡¨æƒ…æ¸©å’Œ..."
                                                ></textarea>
                                            </div>
                                        </div>

                                        <div class="mt-3">
                                            <label class="form-label"
                                                >æç¤ºè¯é¢„è§ˆ</label
                                            >
                                            <div
                                                id="promptPreview"
                                                class="alert alert-secondary"
                                                style="
                                                    white-space: pre-wrap;
                                                    min-height: 60px;
                                                "
                                            ></div>
                                        </div>

                                        <button
                                            id="generateBtn"
                                            class="btn btn-primary w-100 mt-3"
                                        >
                                            ç”Ÿæˆå›¾ç‰‡
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- é¢„è§ˆ -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">ç”Ÿæˆé¢„è§ˆ</div>
                                    <div
                                        class="card-body preview-container"
                                        id="generatedPreview"
                                    >
                                        <p class="text-muted">
                                            ç‚¹å‡»â€œç”Ÿæˆå›¾ç‰‡â€åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨æ­¤å¤„ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›¾ç‰‡ç¼–è¾‘ -->
                    <div
                        class="tab-pane fade"
                        id="image-split"
                        role="tabpanel"
                        aria-labelledby="image-split-tab"
                    >
                        <!-- åœ¨â€œå›¾ç‰‡ç¼–è¾‘â€ Tab çš„å·¥å…·æ ä¸­ -->
                        <div
                            class="d-flex justify-content-between align-items-center mb-3"
                        >
                            <h5 class="mb-0">å›¾ç‰‡ç¼–è¾‘</h5>
                            <div class="d-flex gap-2">
                                <!-- æ–°å¢ï¼šè£å‰ªæ¨¡å¼é€‰æ‹© -->
                                <select
                                    id="cropMode"
                                    class="form-select form-select-sm"
                                    style="width: auto"
                                >
                                    <option value="quadrants">å››æ ¼è£å‰ª</option>
                                    <option value="free">è‡ªç”±è£å‰ª</option>
                                </select>
                                <button
                                    id="cropToQuadrantsBtn"
                                    class="btn btn-success btn-sm me-2"
                                    disabled
                                >
                                    è£å‰ª
                                </button>
                                <button
                                    id="swapFaceBtn"
                                    class="btn btn-outline-primary btn-sm me-2"
                                    disabled
                                >
                                    æ¢è„¸
                                </button>
                                <button
                                    id="saveCroppedImagesBtn"
                                    class="btn btn-primary btn-sm"
                                    disabled
                                >
                                    ä¿å­˜
                                </button>
                            </div>
                        </div>

                        <!-- ç¼–è¾‘åŒºåŸŸå®¹å™¨ -->
                        <div
                            id="imageEditContainer"
                            class="position-relative border rounded bg-dark-subtle"
                            style="width: 100%; height: 70vh"
                        >
                            <!-- å ä½æç¤ºï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
                            <div
                                id="imageEditPlaceholder"
                                class="d-flex justify-content-center align-items-center h-100 w-100 text-muted"
                                style="position: absolute; inset: 0; z-index: 1"
                            >
                                è¯·æ‹–å…¥ä¸€å¼ å›¾ç‰‡ä»¥å¼€å§‹ç¼–è¾‘
                            </div>

                            <!-- Canvasï¼ˆå§‹ç»ˆå­˜åœ¨ï¼Œä½†åˆå§‹æ— å†…å®¹ï¼‰ -->
                            <canvas
                                id="editCanvas"
                                class="w-100 h-100"
                                style="display: block; background: #121212"
                            ></canvas>

                            <!-- éšè—çš„å›¾ç‰‡åŠ è½½å™¨ -->
                            <img
                                id="hiddenImageLoader"
                                style="display: none"
                                crossorigin="anonymous"
                            />
                        </div>
                    </div>

                    <!-- æ•…äº‹æ¿ -->
                    <div
                        class="tab-pane fade"
                        id="storyboard"
                        role="tabpanel"
                        aria-labelledby="storyboard-tab"
                    >
                        <!-- é¡¶éƒ¨å·¥å…·æ  -->
                        <div
                            class="d-flex justify-content-between align-items-center mb-3"
                        >
                            <div class="d-flex align-items-center gap-2 mb-0">
                                <!-- å¯ç¼–è¾‘æ ‡é¢˜ -->
                                <div
                                    class="storyboard-title-container d-flex align-items-center"
                                >
                                    <div
                                        class="storyboard-title-display d-flex align-items-center"
                                    >
                                        <span id="storyboardTitleText"
                                            >æœªå‘½åæ•…äº‹æ¿</span
                                        >
                                        <button
                                            id="editTitleBtn"
                                            class="btn btn-link text-light p-0 ms-2"
                                            style="
                                                font-size: 0.9em;
                                                opacity: 0.6;
                                            "
                                            title="é‡å‘½å"
                                        >
                                            âœï¸
                                        </button>
                                    </div>
                                    <input
                                        type="text"
                                        id="storyboardTitleInput"
                                        class="form-control form-control-sm d-none"
                                        value="æœªå‘½åæ•…äº‹æ¿"
                                        style="
                                            width: auto;
                                            min-width: 120px;
                                            display: inline-block;
                                        "
                                    />
                                </div>
                                <!-- ä¸‹æ‹‰æŒ‰é’® -->
                                <div class="dropdown">
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        type="button"
                                        id="storyboardDropdownBtn"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        style="padding: 0.25rem 0.5rem"
                                    >
                                        â–¼
                                    </button>
                                    <ul
                                        class="dropdown-menu dropdown-menu-end"
                                        aria-labelledby="storyboardDropdownBtn"
                                        id="storyboardDropdownMenu"
                                    >
                                        <li>
                                            <a
                                                class="dropdown-item"
                                                href="#"
                                                data-action="new"
                                                >ğŸ†• æ–°å»ºæ•…äº‹æ¿</a
                                            >
                                        </li>
                                        <li><hr class="dropdown-divider" /></li>
                                        <!-- åŠ¨æ€æ•…äº‹æ¿åˆ—è¡¨å°†æ’å…¥åˆ°è¿™é‡Œ -->
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button
                                    id="addStoryboardPanelBtn"
                                    class="btn btn-outline-info btn-sm"
                                >
                                    + æ·»åŠ åˆ†é•œ
                                </button>
                                <button
                                    id="saveStoryboardBtn"
                                    class="btn btn-primary btn-sm"
                                    disabled
                                >
                                    ä¿å­˜
                                </button>
                            </div>
                        </div>

                        <!-- æ‹–å…¥æç¤º / é¢æ¿å®¹å™¨ï¼ˆä¸å˜ï¼‰ -->
                        <div
                            id="storyboardPlaceholder"
                            class="d-flex justify-content-center align-items-center text-muted py-5"
                            style="min-height: 300px"
                        >
                            ğŸï¸ æ·»åŠ åˆ†é•œï¼Œæˆ–ä»ä¸‹æ‹‰èœå•é€‰æ‹©æ•…äº‹æ¿
                        </div>
                        <div
                            id="storyboardPanels"
                            class="row g-3"
                            style="display: none"
                        ></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨å±€æç¤ºå®¹å™¨ -->
        <div
            id="globalToastContainer"
            class="position-fixed top-0 end-0 p-3"
            style="z-index: 1055; pointer-events: none"
        >
            <!-- åŠ¨æ€ toast å°†è¢«æ’å…¥åˆ°è¿™é‡Œ -->
        </div>

        <!-- å…¨å±é®ç½©ï¼ˆç”¨äºæ¢è„¸ç­‰è€—æ—¶æ“ä½œï¼‰ -->
        <div
            id="fullscreenMask"
            class="position-fixed top-0 start-0 w-100 h-100 d-none"
            style="
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1050;
                display: none;
            "
        >
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-light text-center">
                    <div
                        class="spinner-border text-light mb-2"
                        role="status"
                    ></div>
                    <div>æ­£åœ¨å¤„ç†æ¢è„¸ï¼Œè¯·ç¨å€™...</div>
                </div>
            </div>
        </div>

        <!-- å¿«æ·è®¿é—®çª—å£ -->
        <div id="quickAccessWindow" class="floating-window d-none">
            <div class="floating-header">
                <span>å¿«æ·è®¿é—®</span>
                <button
                    type="button"
                    class="btn-close"
                    data-dismiss="quick-access"
                ></button>
            </div>
            <div class="quick-images-container"></div>
            <div class="resize-handle"></div>
        </div>

        <!-- å†å²è®°å½•çª—å£ -->
        <div id="historyWindow" class="floating-window d-none">
            <div class="floating-header">
                <span>å†å²è®°å½•</span>
                <button
                    type="button"
                    class="btn-close"
                    data-dismiss="history-window"
                ></button>
            </div>
            <div class="history-content">
                <div id="historyWindowList" class="row"></div>
                <nav aria-label="å†å²ç¿»é¡µ" class="mt-2">
                    <ul
                        class="pagination justify-content-center"
                        id="historyWindowPagination"
                    ></ul>
                </nav>
            </div>
            <div class="resize-handle"></div>
        </div>

        <!-- å›¾ç‰‡è¯¦æƒ…Modal -->
        <div id="historyDetailModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title">å†å²è®°å½•è¯¦æƒ…</h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer"></div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
        <script src="{{ url_for('static', filename='state.js') }}"></script>
        <script src="{{ url_for('static', filename='upload.js') }}"></script>
        <script src="{{ url_for('static', filename='quick-access.js') }}"></script>
        <script src="{{ url_for('static', filename='image-edit.js') }}"></script>
        <script src="{{ url_for('static', filename='storyboard.js') }}"></script>
        <script src="{{ url_for('static', filename='main.js') }}"></script>
    </body>
</html>


---------------------
main.js å†…å®¹å¦‚ä¸‹
--------------------
// main.js
//

(function () {
  const state = window.AIImageState;
  // å…¨å±€å˜é‡è®°å½•å½“å‰é¡µ
  let currentHistoryWindowPage = 1;

  // ===== æç¤ºè¯é¢„è§ˆ =====
  function updatePromptPreview() {
    let text = "";
    if ($("#modeRaw").is(":checked")) {
      text = $("#promptRaw").val();
    } else if ($("#modeStoryboard").is(":checked")) {
      const pre = $("#prePrompt").val();
      const style = $("#style").val();
      const s1 = $("#shot1").val();
      const s2 = $("#shot2").val();
      const s3 = $("#shot3").val();
      const s4 = $("#shot4").val();
      text = `${pre}ï¼Œç”Ÿæˆå››æ ¼åˆ†é•œï¼ˆ${style}ï¼‰ï¼š\nåˆ†é•œä¸€ï¼š${s1}\nåˆ†é•œäºŒï¼š${s2}\nåˆ†é•œä¸‰ï¼š${s3}\nåˆ†é•œå››ï¼š${s4}`;
    } else if ($("#modeCharacter").is(":checked")) {
      // è§’è‰²æ¨¡å¼é€»è¾‘
      const views = [];
      if ($("#viewFront").is(":checked")) views.push("æ­£é¢å…¨èº«");
      if ($("#viewSide").is(":checked")) views.push("ä¾§é¢å…¨èº«");
      if ($("#viewBack").is(":checked")) views.push("èƒŒé¢å…¨èº«");
      if ($("#viewFace").is(":checked")) views.push("é¢éƒ¨ç‰¹å†™");
      if ($("#viewSolidBg").is(":checked")) views.push("çº¯è‰²èƒŒæ™¯");

      if (views.length === 0) {
        text = "ï¼ˆè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§†è§’ï¼‰";
      } else {
        const viewText = views.join("å’Œ");
        const notes = $("#characterNotes").val().trim();
        text = `ç»™æˆ‘ä¸€ä¸ªè¿™ä¸ªè§’è‰²çš„${viewText}ã€‚è¦æ±‚è§’è‰²é¢éƒ¨ç‰¹å¾ä¿æŒä¸€è‡´ã€‚${notes ? " " + notes : ""}`;
      }
    }
    $("#promptPreview").text(text || "ï¼ˆæç¤ºè¯ä¸ºç©ºï¼‰");
  }

  // ===== ç”Ÿæˆå›¾ç‰‡ =====
  let isGenerating = false;
  $("#generateBtn").click(function () {
    if (isGenerating) return;
    const prompt = $("#promptPreview").text().trim();
    if (!prompt || prompt === "ï¼ˆæç¤ºè¯ä¸ºç©ºï¼‰") {
      alert("è¯·å¡«å†™æç¤ºè¯");
      return;
    }

    isGenerating = true;
    $(this).prop("disabled", true).text("ç”Ÿæˆä¸­...");

    $.ajax({
      url: "/generate",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        image_urls: state.getUploadedUrls(),
        local_input_paths: state.getLocalPaths(),
        prompt: prompt,
        size: $("#resolution").val(),
        aspect_ratio: $("#aspectRatio").val(),
      }),
      success: function (res) {
        if (res.success) {
          let html = "";
          res.result_urls.forEach((url) => {
            html += `
                            <div class="mb-3">
                                <a href="${url}" data-lightbox="generated"><img src="${url}" class="img-fluid rounded" style="max-height:300px;"></a>
                                <div class="mt-2">
                                    <a href="${url}" download class="btn btn-sm btn-outline-light">ä¸‹è½½</a>
                                </div>
                            </div>
                        `;
          });
          $("#generatedPreview").html(html);
          loadHistoryWindowPage(1);
        } else {
          alert("ç”Ÿæˆå¤±è´¥: " + (res.error || "æœªçŸ¥é”™è¯¯"));
        }
      },
      error: function (xhr) {
        const err = xhr.responseJSON?.error || "è¯·æ±‚å¤±è´¥";
        alert("ç”Ÿæˆé”™è¯¯: " + err);
      },
      complete: function () {
        isGenerating = false;
        $("#generateBtn").prop("disabled", false).text("ç”Ÿæˆå›¾ç‰‡");
      },
    });
  });

  /**
   * å°†æŒ‡å®šå›¾ç‰‡è½½å…¥â€œå›¾ç‰‡ç¼–è¾‘â€æ ‡ç­¾é¡µå¹¶æ¿€æ´»
   * @param {Object} item - åŒ…å« localPath æˆ– remoteUrl çš„å¯¹è±¡
   */
  function enterImageEditMode(item) {
    // 1. åˆ‡æ¢åˆ°â€œå›¾ç‰‡ç¼–è¾‘â€æ ‡ç­¾
    const editTabBtn = document.querySelector("#image-split-tab");
    if (editTabBtn) {
      const tab = new bootstrap.Tab(editTabBtn);
      tab.show();
    }

    // 2. ä¼˜å…ˆä½¿ç”¨æœ¬åœ°è·¯å¾„ï¼ˆlocalPathï¼‰ï¼Œæ²¡æœ‰åˆ™ç”¨è¿œç¨‹ URLï¼ˆremoteUrlï¼‰
    const imgUrl = item.localPath || item.remoteUrl;
    if (!imgUrl) {
      console.warn("No image URL to edit", item);
      return;
    }

    // 3. è§¦å‘å›¾ç‰‡åŠ è½½ï¼ˆä¸ drag-drop é€»è¾‘ä¸€è‡´ï¼‰
    $("#hiddenImageLoader").attr("src", imgUrl);
    $("#imageEditPlaceholder").hide();
  }

  // ===== äº‹ä»¶ç»‘å®š =====
  $(document).ready(function () {
    // æ¨¡å¼åˆ‡æ¢
    $('input[name="mode"]').change(function () {
      $("#rawSection").toggle(this.value === "raw");
      $("#storyboardSection").toggle(this.value === "storyboard");
      $("#characterSection").toggle(this.value === "character");
      updatePromptPreview();
    });

    $(
      "#promptRaw, #prePrompt, #style, #shot1, #shot2, #shot3, #shot4, #characterNotes",
    ).on("input", updatePromptPreview);

    // å¤é€‰æ¡†å˜åŒ–ä¹Ÿè¦è§¦å‘é¢„è§ˆæ›´æ–°
    $("#characterSection input[type='checkbox']").on(
      "change",
      updatePromptPreview,
    );

    $(document).on("click", "#historyPagination .page-link", function (e) {
      e.preventDefault();
      loadHistoryWindowPage(parseInt($(this).text()));
    });

    // åˆå§‹åŒ–
    updatePromptPreview();
    loadHistoryWindowPage(1);

    // å¦‚æœä½ å¸Œæœ›åœ¨åˆ‡æ¢æ ‡ç­¾æ—¶æ‰§è¡ŒæŸäº› JS é€»è¾‘ï¼ˆä¾‹å¦‚æ‡’åŠ è½½ã€åˆå§‹åŒ–ç»„ä»¶ç­‰ï¼‰ï¼Œå¯ä»¥ç›‘å¬ Bootstrap çš„ shown.bs.tab äº‹ä»¶ï¼š
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach((tab) => {
      tab.addEventListener("shown.bs.tab", (event) => {
        const targetId = event.target.getAttribute("data-bs-target");
        console.log("åˆ‡æ¢åˆ°æ ‡ç­¾:", targetId);
      });
    });

    // ===== æ‹–æ‹½åˆ°ç›®æ ‡åŒºåŸŸé€»è¾‘ =====

    // ç‚¹å‡»å†å²å¡ç‰‡ï¼Œå¼¹å‡ºè¯¦æƒ…æµ®çª—
    $(document).on("click", ".history-card", function (e) {
      const item = $(this).data("item");
      showHistoryDetailModal(item);
    });

    function showHistoryDetailModal(item) {
      const isFromQuick = item.id?.startsWith("quick-");
      const resultUrl = item.result_paths[0] || item.result_urls[0] || "";

      const hideUseParams =
        item.params.prompt === "free crop" ||
        item.params.prompt === "quadrants crop";

      // æ„å»ºå†…å®¹ï¼ˆå’ŒåŸæ¥ä¸€æ ·ï¼Œä½†ä¸å†åŒ…å«å¤–å±‚ modal ç»“æ„ï¼‰
      const deleteBtn = isFromQuick
        ? ""
        : `<button type="button" class="btn btn-outline-danger btn-sm" id="deleteHistoryBtn" data-id="${item.id}">åˆ é™¤</button>`;

      const useParamsBtn = hideUseParams
        ? ""
        : `<button type="button" class="btn btn-outline-primary" id="useParamsBtn" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>å¤åˆ»</button>`;

      let paramsText = "";
      if (!hideUseParams) {
        paramsText = `
          <strong>æç¤ºè¯ï¼š</strong>${item.params.prompt.replace(/\n/g, "<br>")}<br>
          <strong>åˆ†è¾¨ç‡ï¼š</strong>${item.params.size}<br>
          <strong>é•¿å®½æ¯”ï¼š</strong>${item.params.aspect_ratio}<br>
          <strong>ç”Ÿæˆæ—¶é—´ï¼š</strong>${new Date(item.timestamp).toLocaleString("zh-CN")}
        `;
      }

      let inputHtml = "";
      if (item.input_paths && item.input_paths.length > 0) {
        inputHtml =
          '<h5 class="mt-3">è¾“å…¥å‚è€ƒå›¾ï¼š</h5><div class="d-flex flex-wrap gap-2">';
        item.input_paths.forEach((url) => {
          inputHtml += `<img src="${url}" style="width:50px;height:50px;object-fit:cover;">`;
        });
        inputHtml += "</div>";
      }

      // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
      const $modal = $("#historyDetailModal");
      $modal.find(".modal-body").html(`
        <div class="text-center mb-3">
          <a href="${resultUrl}" data-lightbox="history-detail">
            <img src="${resultUrl}" class="img-fluid rounded" style="max-height:400px;">
          </a>
        </div>
        ${paramsText}
        ${inputHtml}
      `);

      $modal.find(".modal-footer").html(`
        ${deleteBtn}
        <button type="button" class="btn btn-outline-info" id="editHistoryBtn" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>ç¼–è¾‘</button>
        ${useParamsBtn}
        <button type="button" class="btn btn-outline-success" id="useAsReferenceBtn"
          data-local="${resultUrl}"
          data-remote="${resultUrl}"
          data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
          ä½œä¸ºå‚è€ƒå›¾
        </button>
      `);

      // åˆå§‹åŒ–æˆ–è·å–å·²æœ‰çš„ Modal å®ä¾‹ï¼ˆæ¨èç¼“å­˜ï¼Œä½†ç®€å•åœºæ™¯å¯æ¯æ¬¡éƒ½ newï¼‰
      const modalInstance = bootstrap.Modal.getOrCreateInstance($modal[0]);
      modalInstance.show();
    }
    // æš´éœ²æ–¹æ³•åˆ°å…¨å±€
    window.showHistoryDetailModal = showHistoryDetailModal;

    // ä½¿ç”¨å‚æ•°ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
    $(document).on("click", "#useParamsBtn", function () {
      const item = $(this).data("item");
      // === ä»¥ä¸‹å¤ç”¨ä½ åŸæœ‰çš„â€œä½¿ç”¨å‚æ•°â€é€»è¾‘ ===
      const params = item.params;

      // åˆ¤æ–­æ¨¡å¼ï¼ˆRaw / Storyboard / Characterï¼‰
      let isCharacter = params.prompt.includes("é¢éƒ¨ç‰¹å¾ä¿æŒä¸€è‡´");
      let isStoryboard = params.prompt.includes("ç”Ÿæˆå››æ ¼åˆ†é•œ");

      if (isCharacter) {
        $("#modeCharacter").prop("checked", true).trigger("change");
        // æ¸…ç©ºå¤é€‰æ¡†
        $("#characterSection input[type='checkbox']").prop("checked", false);
        const prompt = params.prompt;
        if (prompt.includes("æ­£é¢å…¨èº«")) $("#viewFront").prop("checked", true);
        if (prompt.includes("ä¾§é¢å…¨èº«")) $("#viewSide").prop("checked", true);
        if (prompt.includes("èƒŒé¢å…¨èº«")) $("#viewBack").prop("checked", true);
        if (prompt.includes("é¢éƒ¨ç‰¹å†™")) $("#viewFace").prop("checked", true);
        if (prompt.includes("çº¯è‰²èƒŒæ™¯"))
          $("#viewSolidBg").prop("checked", true);

        const notesMatch = prompt.match(/é¢éƒ¨ç‰¹å¾ä¿æŒä¸€è‡´\ã€‚ï¼ˆ.*?ï¼‰?$/);
        $("#characterNotes").val(notesMatch ? notesMatch[1] || "" : "");
      } else if (isStoryboard) {
        $("#modeStoryboard").prop("checked", true).trigger("change");
        const lines = params.prompt.split("\n");
        const preMatch = lines[0]?.match(/^(.+)ï¼Œç”Ÿæˆå››æ ¼åˆ†é•œ/);
        $("#prePrompt").val(preMatch ? preMatch[1] : "");
        const styleMatch = lines[0]?.match(/ç”Ÿæˆå››æ ¼åˆ†é•œï¼ˆ(.+?)ï¼‰/);
        $("#style").val(styleMatch ? styleMatch[1] : "");
        $("#shot1").val(lines[1]?.replace("åˆ†é•œä¸€ï¼š", "") || "");
        $("#shot2").val(lines[2]?.replace("åˆ†é•œäºŒï¼š", "") || "");
        $("#shot3").val(lines[3]?.replace("åˆ†é•œä¸‰ï¼š", "") || "");
        $("#shot4").val(lines[4]?.replace("åˆ†é•œå››ï¼š", "") || "");
      } else {
        $("#modeRaw").prop("checked", true).trigger("change");
        $("#promptRaw").val(params.prompt);
      }

      $("#resolution").val(params.size || "2K");
      $("#aspectRatio").val(params.aspect_ratio || "auto");

      // æ¢å¤å‚è€ƒå›¾
      state.clear();
      if (item.input_paths && item.input_paths.length > 0) {
        state.setFromUrls(item.input_urls, item.input_paths);
      }
      if (typeof window.UploadModule?.renderPreview === "function") {
        window.UploadModule.renderPreview();
      }

      updatePromptPreview();
      $("html, body").animate({ scrollTop: 0 }, 300);

      // å…³é—­æµ®çª—
      bootstrap.Modal.getInstance(
        document.getElementById("historyDetailModal"),
      )?.hide();
    });

    // åˆ é™¤è®°å½•
    $(document).on("click", "#deleteHistoryBtn", function () {
      const recordId = $(this).data("id");
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ")) return;

      $.ajax({
        url: `/history/${recordId}`,
        method: "DELETE",
        success: function (res) {
          if (res.success) {
            // å…³é—­æµ®çª—
            bootstrap.Modal.getInstance(
              document.getElementById("historyDetailModal"),
            )?.hide();
            // é‡æ–°åŠ è½½å½“å‰é¡µ
            const currentPage =
              parseInt(
                $("#historyPagination .page-item.active .page-link").text(),
              ) || 1;
            loadHistoryWindowPage(currentPage);
          } else {
            alert("åˆ é™¤å¤±è´¥: " + (res.error || "æœªçŸ¥é”™è¯¯"));
          }
        },
        error: function () {
          alert("åˆ é™¤è¯·æ±‚å¤±è´¥");
        },
      });
    });

    // ç¼–è¾‘æŒ‰é’®
    $(document).on("click", "#editHistoryBtn", function () {
      const item = $(this).data("item");

      // æ„é€ ä¸æ‹–æ‹½é€»è¾‘ä¸€è‡´çš„ item ç»“æ„ï¼š{ localPath, remoteUrl }
      const editItem = {
        localPath: item.result_paths?.[0] || item.result_urls?.[0], // ä¼˜å…ˆæœ¬åœ°è·¯å¾„
        remoteUrl: item.result_urls?.[0],
      };

      enterImageEditMode(editItem);

      // å…³é—­æµ®çª—
      bootstrap.Modal.getInstance(
        document.getElementById("historyDetailModal"),
      )?.hide();
    });

    // æ–°å¢ï¼šä½œä¸ºå‚è€ƒå›¾
    $(document).on("click", "#useAsReferenceBtn", async function () {
      const localPath = $(this).data("local");
      const remoteUrl = $(this).data("remote");
      const item = $(this).data("item");

      let usableLocal = localPath;
      let usableRemote = remoteUrl;

      // è‹¥æ²¡æœ‰æœ‰æ•ˆçš„ ImgBB è¿œç¨‹åœ°å€ï¼Œå…ˆä¸Šä¼ 
      if (!usableRemote || !usableRemote.startsWith("https://")) {
        if (!usableLocal) {
          alert("æ— æ³•è·å–å›¾ç‰‡æºï¼Œæ— æ³•ä½œä¸ºå‚è€ƒå›¾");
          return;
        }

        try {
          const resp = await fetch(usableLocal);
          if (!resp.ok) throw new Error("æ— æ³•è¯»å–æœ¬åœ°å›¾ç‰‡");
          const blob = await resp.blob();
          const formData = new FormData();
          formData.append("file", blob, "reference.jpg");

          const uploadRes = await fetch("/quick-upload", {
            method: "POST",
            body: formData,
          });

          if (!uploadRes.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
          const data = await uploadRes.json();
          usableRemote = data.url;
          usableLocal = data.local_path || usableLocal;
        } catch (e) {
          console.error("ä¸Šä¼ å‚è€ƒå›¾å¤±è´¥:", e);
          showToast("ä¸Šä¼ å‚è€ƒå›¾å¤±è´¥ï¼Œè¯·é‡è¯•", "error", 3000);
          return;
        }
      }

      // åŠ å…¥å‚è€ƒå›¾
      const success = window.AIImageState?.addFromQuickAccess(
        usableLocal,
        usableRemote,
      );
      if (success) {
        if (typeof window.UploadModule?.renderPreview === "function") {
          window.UploadModule.renderPreview();
        }
        showToast("å·²æ·»åŠ ä¸ºå‚è€ƒå›¾", "success", 2000);
        // å…³é—­æ¨¡æ€æ¡†
        bootstrap.Modal.getInstance(
          document.getElementById("historyDetailModal"),
        )?.hide();
      } else {
        showToast("å‚è€ƒå›¾å·²å­˜åœ¨æˆ–æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆæœ€å¤š10å¼ ï¼‰", "warning", 2500);
      }
    });

    // ===== å·¥å…·æ¡å¼¹çª—æ§åˆ¶ =====
    $(document).on("click", ".tool-btn", function () {
      const target = $(this).data("target");
      if (target === "quick-access") {
        $("#quickAccessWindow").removeClass("d-none");
        window.QuickAccess?.renderSidebar(
          "#quickAccessWindow .quick-images-container",
        );
      } else if (target === "history-window") {
        $("#historyWindow").removeClass("d-none");
        loadHistoryWindowPage(1);
      }
    });

    // å…³é—­çª—å£
    $(document).on("click", "[data-dismiss]", function () {
      const target = $(this).data("dismiss");
      if (target === "quick-access") {
        $("#quickAccessWindow").addClass("d-none");
      } else if (target === "history-window") {
        $("#historyWindow").addClass("d-none");
      }
    });

    // å†å²çª—å£åˆ†é¡µ
    function loadHistoryWindowPage(page, limit = 12) {
      currentHistoryWindowPage = page;
      $.get(`/history?page=${page}&limit=${limit}`, function (data) {
        let html = "";
        data.records.forEach((item) => {
          const url = item.result_paths[0] || "";
          html += `
            <div class="col-6 col-sm-4 col-md-3 mb-3">
              <div class="card history-card" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>

                  <img src="${url}" class="w-100" style="aspect-ratio:1/1;object-fit:cover;" draggable="true">

              </div>
            </div>
          `;
        });
        $("#historyWindowList").html(html);

        let pg = "";
        for (let i = 1; i <= data.pages; i++) {
          pg += `<li class="page-item ${i === page ? "active" : ""}"><a class="page-link" href="#">${i}</a></li>`;
        }
        $("#historyWindowPagination").html(pg);
      });
    }

    $(document).on(
      "click",
      "#historyWindowPagination .page-link",
      function (e) {
        e.preventDefault();
        const page = parseInt($(this).text());
        // é‡æ–°è®¡ç®—å½“å‰ limitï¼ˆæˆ–ç¼“å­˜ï¼‰
        const win = document.getElementById("historyWindow");
        const containerWidth =
          win?.querySelector(".history-content")?.clientWidth || 400;
        const limit = calculateHistoryItemsPerPage(containerWidth);
        loadHistoryWindowPage(page, limit);
      },
    );

    // å†å²çª—å£å¡ç‰‡ç‚¹å‡»
    $(document).on("click", "#historyWindowList .history-card", function () {
      const item = $(this).data("item");
      window.showHistoryDetailModal(item);
    });

    // ===== æ‹–æ‹½ç§»åŠ¨æµ®åŠ¨çª—å£ =====
    function makeWindowDraggable(windowSelector) {
      const winEl = document.querySelector(windowSelector); // â† æ”¹åï¼šwinEl
      if (!winEl) return;

      let pos1 = 0,
        pos2 = 0,
        pos3 = 0,
        pos4 = 0;

      const header = winEl.querySelector(".floating-header");
      if (!header) return;

      header.style.cursor = "move";

      header.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;

        // âœ… æ­£ç¡®è®¡ç®—æ–°ä½ç½®
        const newLeft = winEl.offsetLeft - pos1;
        const newTop = winEl.offsetTop - pos2;

        // âœ… ä½¿ç”¨å…¨å±€ window.innerWidth/Heightï¼ˆæ³¨æ„ï¼šä¸æ˜¯ winEl.innerWidthï¼ï¼‰
        const maxX = window.innerWidth - winEl.offsetWidth;
        const maxY = window.innerHeight - winEl.offsetHeight;

        // âœ… é™åˆ¶è¾¹ç•Œ
        winEl.style.left = Math.max(0, Math.min(newLeft, maxX)) + "px";
        winEl.style.top = Math.max(0, Math.min(newTop, maxY)) + "px";

        // âœ… ç§»é™¤ transformï¼ˆç¡®ä¿å®šä½åŸºäº left/topï¼‰
        winEl.style.transform = "none";
      }

      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    // åˆå§‹åŒ–æ‹–æ‹½
    makeWindowDraggable("#quickAccessWindow");
    makeWindowDraggable("#historyWindow");

    // ===== æ‚¬æµ®çª—å£å›¾ç‰‡æ‹–æ‹½æ”¯æŒ =====
    $(document).on(
      "dragstart",
      "#historyWindow .history-card img, #quickAccessWindow .quick-img-item img",
      function (e) {
        const originalEvent = e.originalEvent;
        let itemData = null;

        // æ¥æºï¼šå†å²è®°å½•
        if ($(this).closest("#historyWindow").length) {
          const item = $(this).data("history-item");
          if (item) {
            itemData = {
              type: "history",
              localPath: item.result_paths?.[0] || "",
              remoteUrl: item.result_urls?.[0] || "",
              inputPaths: item.input_paths || [],
              inputUrls: item.input_urls || [],
              params: item.params || {},
            };
          }
        }
        // æ¥æºï¼šå¿«æ·è®¿é—®
        else if ($(this).closest("#quickAccessWindow").length) {
          const item = $(this).data("quick-item");
          if (item) {
            itemData = {
              type: "quick",
              localPath: item.localPath,
              remoteUrl: item.remoteUrl,
              category: item.category,
              group: item.group,
              viewType: item.viewType,
              note: item.note,
            };
          }
        }

        if (itemData) {
          // å­˜å‚¨åˆ°å…¨å±€ï¼ˆä¾› drop åŒºåŸŸè¯»å–ï¼‰
          window.__draggedItem = itemData;

          // è®¾ç½®æ‹–å½±
          const img = this.cloneNode(true);
          img.style.width = "80px";
          img.style.height = "80px";
          img.style.opacity = "0.9";
          img.style.borderRadius = "4px";
          img.style.objectFit = "cover";
          img.style.pointerEvents = "none";
          const ghost = document.createElement("div");
          ghost.appendChild(img);
          ghost.style.position = "absolute";
          ghost.style.top = "-9999px";
          document.body.appendChild(ghost);
          originalEvent.dataTransfer.setDragImage(ghost, 40, 40);

          // æ¸…ç†
          const cleanup = () => {
            if (ghost.parentNode) ghost.parentNode.removeChild(ghost);
            document.removeEventListener("dragend", cleanup);
          };
          document.addEventListener("dragend", cleanup);

          // ä¸æ˜¾ç¤º #dragTargetOverlayï¼ˆä½ å·²ç§»é™¤ï¼Œæ‰€ä»¥è·³è¿‡ï¼‰
          return;
        }
      },
    );

    // å¿«æ·è®¿é—®çª—å£æ¥æ”¶å†å²å›¾
    $(document).on(
      "dragover",
      "#quickAccessWindow .quick-images-container",
      function (e) {
        e.preventDefault();
      },
    );
    $(document).on(
      "drop",
      "#quickAccessWindow .quick-images-container",
      function (e) {
        e.preventDefault();
        const item = window.__draggedItem;
        if (item && item.type === "history") {
          // æå–ä¸»å›¾
          const imgToAdd = {
            localPath: item.localPath,
            remoteUrl: item.remoteUrl,
          };
          window.QuickAccess?.addImage(imgToAdd);
          showToast("å·²æ·»åŠ åˆ°å¿«æ·è®¿é—®", "success", 2000);
        }
        window.__draggedItem = null;
      },
    );

    function makeResizable(windowSelector) {
      const win = document.querySelector(windowSelector);
      if (!win) return;

      const handle = win.querySelector(".resize-handle");
      if (!handle) return;

      let isResizing = false;

      handle.addEventListener("mousedown", (e) => {
        e.preventDefault();
        isResizing = true;
        document.body.classList.add("resizing");
        document.addEventListener("mousemove", resize);
        document.addEventListener("mouseup", stopResize);
      });

      function resize(e) {
        if (!isResizing) return;
        const rect = win.getBoundingClientRect();
        const dx = e.clientX - rect.right;
        const dy = e.clientY - rect.bottom;

        let newWidth = rect.width + dx;
        let newHeight = rect.height + dy;

        // é™åˆ¶ min/max
        newWidth = Math.min(800, Math.max(300, newWidth));
        newHeight = Math.min(600, Math.max(200, newHeight));

        win.style.width = newWidth + "px";
        win.style.height = newHeight + "px";
      }

      function stopResize() {
        isResizing = false;
        document.body.classList.remove("resizing");
        document.removeEventListener("mousemove", resize);
        document.removeEventListener("mouseup", stopResize);

        // âœ… è°ƒæ•´ç»“æŸï¼šå¦‚æœæ˜¯å†å²çª—å£ï¼Œé‡æ–°åŠ è½½
        if (windowSelector === "#historyWindow") {
          debouncedReloadHistoryWindow();
        }
      }
    }

    function calculateHistoryItemsPerPage(containerWidth) {
      // æ¯å¼ å¡ç‰‡çº¦ 100px å®½ï¼ˆå« gutterï¼‰
      const cols = Math.max(2, Math.floor(containerWidth / 110));
      // é«˜åº¦åŒºåŸŸçº¦ 400px å¯ç”¨ï¼Œæ¯è¡Œ 120px
      const rows = Math.max(2, Math.floor(400 / 120));
      return cols * rows;
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    const debouncedReloadHistoryWindow = debounce(() => {
      const win = document.getElementById("historyWindow");
      if (!win) return;

      const containerWidth = win.querySelector(".history-content").clientWidth;
      const newLimit = calculateHistoryItemsPerPage(containerWidth);

      // å¯é€‰ï¼šå­˜å…¥å…¨å±€æˆ–é—­åŒ…ï¼Œé¿å…é‡å¤åŠ è½½ç›¸åŒ limit
      loadHistoryWindowPage(currentHistoryWindowPage, newLimit);
    }, 300);

    makeResizable("#quickAccessWindow");
    makeResizable("#historyWindow");

    // document ready ç»“æŸ
  });
})();


---------------------
state.js å†…å®¹å¦‚ä¸‹
--------------------
// state.js

// å…¨å±€æç¤ºå‡½æ•°
function showToast(message, type = "info", delay = 0) {
  // type: 'success', 'error', 'warning', 'info'
  const colors = {
    success: "green",
    error: "red",
    warning: "orange",
    info: "blue",
  };
  const bgColor = colors[type] || "blue";

  const toastId = "toast-" + Date.now();
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white border-0 mb-2" role="alert" style="background-color: ${bgColor}; min-width: 250px; pointer-events: auto;">
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;

  const container = document.getElementById("globalToastContainer");
  container.insertAdjacentHTML("beforeend", toastHtml);

  const toastEl = document.getElementById(toastId);
  let toast = null;
  if (delay == 0) {
    toast = new bootstrap.Toast(toastEl, {
      autohide: false,
    });
  } else if (delay > 0) {
    toast = new bootstrap.Toast(toastEl, {
      autohide: true,
      delay: delay,
    });
  }

  toast.show();

  // è‡ªåŠ¨æ¸…ç†å·²éšè—çš„ toast
  toastEl.addEventListener("hidden.bs.toast", () => {
    toastEl.remove();
  });
}

window.AIImageState = (function () {
  let uploadedImageUrls = [];
  let uploadedLocalPaths = [];

  return {
    getUploadedUrls() {
      return [...uploadedImageUrls];
    },
    getLocalPaths() {
      return [...uploadedLocalPaths];
    },
    setUploadedUrls(urls) {
      uploadedImageUrls = [...urls];
    },
    setLocalPaths(paths) {
      uploadedLocalPaths = [...paths];
    },
    addUploadedFiles(urls, localPaths) {
      uploadedImageUrls.push(...urls);
      uploadedLocalPaths.push(...localPaths);
    },
    removeAtIndex(index) {
      uploadedImageUrls.splice(index, 1);
      uploadedLocalPaths.splice(index, 1);
    },
    swapIndices(i, j) {
      if (
        i < 0 ||
        j < 0 ||
        i >= uploadedImageUrls.length ||
        j >= uploadedImageUrls.length
      )
        return;
      [uploadedImageUrls[i], uploadedImageUrls[j]] = [
        uploadedImageUrls[j],
        uploadedImageUrls[i],
      ];
      [uploadedLocalPaths[i], uploadedLocalPaths[j]] = [
        uploadedLocalPaths[j],
        uploadedLocalPaths[i],
      ];
    },
    clear() {
      uploadedImageUrls = [];
      uploadedLocalPaths = [];
    },
    getCount() {
      return uploadedLocalPaths.length;
    },
    setFromUrls: function (urls, paths) {
      uploadedImageUrls = [...urls];
      uploadedLocalPaths = [...paths]; // mock æ–‡ä»¶å
    },
    addFromQuickAccess(localPath, remoteUrl) {
      const exists =
        uploadedLocalPaths.includes(localPath) ||
        uploadedImageUrls.includes(remoteUrl);
      if (exists) return false;
      if (uploadedLocalPaths.length >= 10) return false;
      uploadedLocalPaths.push(localPath);
      uploadedImageUrls.push(remoteUrl);
      return true;
    },
  };
})();


---------------------
storyboard.js å†…å®¹å¦‚ä¸‹
--------------------
// storyboard.js - æ•…äº‹æ¿ç¼–è¾‘å™¨
(() => {
  const PANEL_MAX_COUNT = 12;
  const CAMERA_MOVEMENTS = [
    { value: "fixed", label: "å›ºå®šé•œå¤´" },
    { value: "pan", label: "æ¨ªæ‘‡ï¼ˆPanï¼‰" },
    { value: "tilt", label: "ä¿¯ä»°ï¼ˆTiltï¼‰" },
    { value: "zoom_in", label: "æ¨è¿›ï¼ˆZoom Inï¼‰" },
    { value: "zoom_out", label: "æ‹‰è¿œï¼ˆZoom Outï¼‰" },
    { value: "dolly_in", label: "æ¨è½¨é è¿‘ï¼ˆDolly Inï¼‰" },
    { value: "dolly_out", label: "æ¨è½¨è¿œç¦»ï¼ˆDolly Outï¼‰" },
    { value: "track_left", label: "å·¦ç§»è·Ÿæ‹" },
    { value: "track_right", label: "å³ç§»è·Ÿæ‹" },
    { value: "track_forward", label: "å‰è¿›è·Ÿæ‹" },
    { value: "track_backward", label: "åé€€è·Ÿæ‹" },
    { value: "handheld", label: "æ‰‹æŒæ™ƒåŠ¨" },
    { value: "crane_up", label: " crane ä¸Šå‡" },
    { value: "crane_down", label: " crane ä¸‹é™" },
    { value: "static_with_focus_rack", label: "å›ºå®š + ç„¦ç‚¹è½¬ç§»" },
    { value: "other", label: "å…¶ä»–ï¼ˆè¯·è¯´æ˜ï¼‰" },
  ];

  let storyboardState = {
    currentId: null, // å½“å‰æ‰“å¼€çš„æ•…äº‹æ¿ ID
    title: "æœªå‘½åæ•…äº‹æ¿", // å½“å‰æ ‡é¢˜
    panels: [],
  };

  // è·å–æ‰€æœ‰å·²ä¿å­˜çš„æ•…äº‹æ¿ï¼ˆä»æœ¬åœ° storyboards/ ç›®å½•ï¼‰
  async function loadStoryboardList() {
    try {
      const resp = await fetch("/list-storyboards");
      const list = await resp.json();
      const select = $("#storyboardSelector");
      // ä¿ç•™å‰ä¸¤ä¸ªé€‰é¡¹ï¼ˆâ€”é€‰æ‹©â€” å’Œ æ–°å»ºï¼‰
      const staticOptions = select.find("option:lt(2)").clone();
      select.empty().append(staticOptions);
      // æ·»åŠ å·²ä¿å­˜çš„æ•…äº‹æ¿
      list.forEach((sb) => {
        const opt = $(
          `<option value="${sb.id}">${sb.title || "æœªå‘½å"}</option>`,
        );
        if (sb.id === storyboardState.currentId) {
          opt.prop("selected", true);
        }
        select.append(opt);
      });
    } catch (err) {
      console.error("åŠ è½½æ•…äº‹æ¿åˆ—è¡¨å¤±è´¥", err);
    }
  }

  async function loadStoryboardListIntoDropdown() {
    try {
      const resp = await fetch("/list-storyboards");
      const list = await resp.json();
      const menu = $("#storyboardDropdownMenu");
      // æ¸…ç©ºåŠ¨æ€éƒ¨åˆ†ï¼ˆä¿ç•™å‰ä¸¤é¡¹ï¼šæ–°å»º + åˆ†å‰²çº¿ï¼‰
      menu.find("li:not(:first-child):not(:nth-child(2))").remove();
      list.forEach((sb) => {
        const isActive = sb.id === storyboardState.currentId;
        const li = $(`
          <li>
            <a class="dropdown-item ${isActive ? "active" : ""}" href="#" data-id="${sb.id}">
              ${sb.title || "æœªå‘½åæ•…äº‹æ¿"}
            </a>
          </li>
        `);
        menu.append(li);
      });
    } catch (err) {
      console.error("åŠ è½½æ•…äº‹æ¿åˆ—è¡¨å¤±è´¥", err);
    }
  }

  function bindDropZoneEvents() {
    const container = document.getElementById("storyboardPanels");
    if (!container) return;

    // å…¨å±€ï¼šé˜»æ­¢é»˜è®¤ dragover è¡Œä¸ºï¼ˆå¦åˆ™æ— æ³• dropï¼‰
    container.addEventListener("dragover", (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
    });

    // æ‹–å…¥æŸä¸ªåˆ†é•œçš„ .panel-images åŒºåŸŸ
    container.addEventListener("dragenter", (e) => {
      const target = e.target.closest(".panel-images");
      if (target) {
        target.classList.add("storyboard-drop-target");
      }
    });

    container.addEventListener("dragleave", (e) => {
      const target = e.target.closest(".panel-images");
      if (target) {
        // é˜²æ­¢å­å…ƒç´  leave è§¦å‘çˆ¶å…ƒç´  leave
        const related = e.relatedTarget;
        if (!target.contains(related)) {
          target.classList.remove("storyboard-drop-target");
        }
      }
    });

    // æ ¸å¿ƒï¼šdrop äº‹ä»¶
    container.addEventListener("drop", async (e) => {
      e.preventDefault();
      const url = e.dataTransfer.getData("text/plain");
      if (!url) return;

      // æ¸…é™¤æ‰€æœ‰é«˜äº®
      container.querySelectorAll(".storyboard-drop-target").forEach((el) => {
        el.classList.remove("storyboard-drop-target");
      });

      // åˆ¤æ–­æ˜¯å¦ drop åˆ°æŸä¸ªåˆ†é•œçš„ .panel-images
      const panelImages = e.target.closest(".panel-images");
      if (panelImages) {
        // æƒ…å†µ2ï¼šæ·»åŠ åˆ°æŒ‡å®šåˆ†é•œ
        const panelId = panelImages.closest("[data-panel-id]").dataset.panelId;
        const panel = storyboardState.panels.find(
          (p) => p.panel_id === panelId,
        );
        if (panel) {
          panel.images.push(url);
          renderPanels();
          applyUniformAspectRatio();
          updateSaveButton();
          showToast("å›¾ç‰‡å·²æ·»åŠ åˆ°åˆ†é•œ", "success", 2000);
        }
      } else {
        // æƒ…å†µ1ï¼šæ•…äº‹æ¿ä¸ºç©º OR æ‹–åˆ°ç©ºç™½åŒºåŸŸ â†’ æ–°å»ºåˆ†é•œ
        if (storyboardState.panels.length === 0) {
          addPanel({
            images: [url],
            description: "",
            cameraMovement: "fixed",
            cameraNote: "",
          });
          showToast("å·²åˆ›å»ºæ–°åˆ†é•œå¹¶æ·»åŠ å›¾ç‰‡", "success", 2000);
        } else {
          // å¯é€‰ï¼šä¹Ÿå¯ä»¥æç¤ºâ€œè¯·æ‹–åˆ°å…·ä½“åˆ†é•œåŒºåŸŸâ€
          showToast("è¯·å°†å›¾ç‰‡æ‹–åˆ°å…·ä½“åˆ†é•œå¡ç‰‡å†…", "info", 2000);
        }
      }
    });
  }

  function init() {
    renderPanels();
    applyUniformAspectRatio();
    bindGlobalEvents();
    bindDropZoneEvents();
  }

  function bindGlobalEvents() {
    $("#storyboardTitle").on("blur input", function () {
      const newTitle = $(this).text().trim() || "æœªå‘½åæ•…äº‹æ¿";
      $(this).text(newTitle);
      storyboardState.title = newTitle;
      // å¯é€‰ï¼šè‡ªåŠ¨ä¿å­˜è‰ç¨¿ï¼ˆæˆ–ä»…æ ‡è®° dirtyï¼‰
    });

    $("#newStoryboardBtn").click(resetStoryboard);

    $("#addStoryboardPanelBtn").click(() => {
      if (storyboardState.panels.length >= PANEL_MAX_COUNT) {
        showToast(`æœ€å¤šæ”¯æŒ ${PANEL_MAX_COUNT} ä¸ªåˆ†é•œ`, "error", 5000);
        return;
      }
      addPanel({
        images: [],
        description: "",
        cameraMovement: "fixed",
        cameraNote: "",
      });
    });

    $("#saveStoryboardBtn").click(saveStoryboard);
  }

  // æ¸…ç©ºå½“å‰æ•…äº‹æ¿ï¼Œå¼€å§‹æ–°çš„
  function resetStoryboard() {
    if (storyboardState.panels.length > 0) {
      if (
        !confirm("å½“å‰æ•…äº‹æ¿æœ‰å†…å®¹ï¼Œç¡®å®šè¦æ–°å»ºä¸€ä¸ªå—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ã€‚")
      ) {
        return;
      }
    }
    storyboardState.panels = [];
    renderPanels();
    applyUniformAspectRatio();
    updateSaveButton();
  }

  function addPanel(data) {
    const panel_id = data.panel_id || crypto.randomUUID();
    storyboardState.panels.push({ panel_id, ...data });
    console.log(storyboardState);
    renderPanels();
    applyUniformAspectRatio();
    updateSaveButton();
    document
      .getElementById("storyboardPanels")
      .scrollIntoView({ behavior: "smooth" });
    //$("#storyboardPlaceholder").removeClass("d-flex").hide();
  }

  function removePanel(id) {
    storyboardState.panels = storyboardState.panels.filter(
      (p) => p.panel_id !== id,
    );
    renderPanels();
    applyUniformAspectRatio();
    updateSaveButton();
  }

  function updatePanel(id, updates) {
    const panel = storyboardState.panels.find((p) => p.panel_id === id);
    if (panel) Object.assign(panel, updates);
    updateSaveButton();
  }

  function renderPanels() {
    const container = $("#storyboardPanels");
    const placeholder = $("#storyboardPlaceholder");

    if (storyboardState.panels.length === 0) {
      $("#storyboardPlaceholder").addClass("d-flex").show();
      container.hide();
      placeholder.show();
      $("#storyboardTitleInput").val(storyboardState.title);
      $("#storyboardTitleText").text(storyboardState.title);
    } else {
      $("#storyboardPlaceholder").removeClass("d-flex").hide();
      placeholder.hide();
      container.show();
      $("#storyboardTitleInput").val(storyboardState.title);
      $("#storyboardTitleText").text(storyboardState.title);
      let html = "";
      storyboardState.panels.forEach((panel) => {
        const imgHtml =
          panel.images.length === 0
            ? '<div class="text-center text-muted py-3">ä¸Šä¼ æˆ–æ‹–å…¥å·²æœ‰å›¾ç‰‡</div>'
            : panel.images
                .map(
                  (url, idx) =>
                    `<a href="${url}" data-lightbox="panel-${panel.panel_id}" style="position:absolute; top:0; left:0; width:90%; height:90%; " class="panel-image-stack-link"><img src="${url}"  class="panel-image-stack" style="z-index:${panel.images.length - idx}"></a>`,
                )
                .join("");

        const cameraOptions = CAMERA_MOVEMENTS.map(
          (opt) =>
            `<option value="${opt.value}" ${panel.camera_movement === opt.value ? "selected" : ""}>${opt.label}</option>`,
        ).join("");

        html += `
          <div class="col-12 col-md-6 col-lg-4" data-panel-id="${panel.panel_id}">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <select class="form-select form-select-sm camera-movement">
                  ${cameraOptions}
                </select>
                <button type="button" class="btn-close btn-sm remove-panel" aria-label="åˆ é™¤"></button>
              </div>
              <div class="card-body d-flex flex-column">
                <div class="panel-images mb-2" style="  display:flex;   gap:2px;">
                  ${imgHtml}
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mb-2 add-image-to-panel">+ æ·»åŠ å›¾ç‰‡</button>
                <textarea class="form-control description mb-2" rows="2" placeholder="é•œå¤´æè¿°ã€å¯¹ç™½ç­‰...">${panel.description}</textarea>
                <textarea class="form-control camera-note ${panel.cameraMovement === "other" ? "" : "d-none"}" rows="1" placeholder="è¯·è¯´æ˜è¿é•œæ–¹å¼...">${panel.cameraNote}</textarea>
              </div>
            </div>
          </div>
        `;
      });
      container.html(html);
      setupPanelEvents();
    }
  }

  // è®¡ç®—å¹¶åº”ç”¨ç»Ÿä¸€çš„å›¾ç‰‡å®½é«˜æ¯”
  async function applyUniformAspectRatio() {
    const panels = storyboardState.panels;
    if (panels.length === 0 || panels[0].images.length === 0) {
      // æ²¡æœ‰å‚è€ƒå›¾ï¼Œæ¢å¤é»˜è®¤æ ·å¼
      $(".panel-images").css("aspect-ratio", "");
      return;
    }

    const firstImageUrl = panels[0].images[0];
    try {
      // åŠ è½½å›¾ç‰‡å¹¶è·å–åŸå§‹å®½é«˜
      const img = new Image();
      await new Promise((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = () => reject(new Error("åŠ è½½å‚è€ƒå›¾å¤±è´¥"));
        img.src = firstImageUrl;
      });

      const aspectRatio = img.naturalWidth / img.naturalHeight;
      // åº”ç”¨åˆ°æ‰€æœ‰ .panel-images å®¹å™¨
      $(".panel-images").css("aspect-ratio", `${aspectRatio}`);
    } catch (err) {
      console.warn("æ— æ³•è·å–ç¬¬ä¸€å¼ å›¾çš„å°ºå¯¸ï¼Œä½¿ç”¨é»˜è®¤æ¯”ä¾‹", err);
      $(".panel-images").css("aspect-ratio", "");
    }
  }

  function setupPanelEvents() {
    $(".remove-panel").click(function () {
      const id = $(this).closest("[data-panel-id]").data("panel-id");
      removePanel(id);
    });

    $(".camera-movement").change(function () {
      const id = $(this).closest("[data-panel-id]").data("panel-id");
      const val = $(this).val();
      updatePanel(id, { cameraMovement: val });
      $(this)
        .closest(".card")
        .find(".camera-note")
        .toggleClass("d-none", val !== "other");
    });

    $(".description, .camera-note").on("input", function () {
      const id = $(this).closest("[data-panel-id]").data("panel-id");
      const field = $(this).hasClass("description")
        ? "description"
        : "cameraNote";
      updatePanel(id, { [field]: this.value });
    });

    $(".add-image-to-panel").click(function () {
      const id = $(this).closest("[data-panel-id]").data("panel-id");
      const input = document.createElement("input");
      console.log(id);
      console.log(storyboardState);
      input.type = "file";
      input.accept = "image/*";
      input.multiple = true;
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        const urls = await uploadFilesAndGetUrls(files);
        const panel = storyboardState.panels.find((p) => p.panel_id === id);
        panel.images = panel.images.concat(urls);

        renderPanels();
        applyUniformAspectRatio();
        updateSaveButton();
      };
      input.click();
    });
  }

  async function uploadFilesAndGetUrls(files) {
    const urls = [];
    for (const file of files) {
      const formData = new FormData();
      formData.append("file", file);
      const resp = await fetch("/quick-upload", {
        method: "POST",
        body: formData,
      });
      const data = await resp.json();
      if (data.local_path) {
        urls.push(data.local_path); // e.g., /uploads/xxx.jpg
      } else {
        throw new Error("ä¸Šä¼ å¤±è´¥");
      }
    }
    return urls;
  }

  function updateSaveButton() {
    const hasContent = storyboardState.panels.some((p) => p.images.length > 0);
    $("#saveStoryboardBtn").prop("disabled", !hasContent);
  }

  // ===== å…¥å£ï¼šä»æ‹–æ‹½ç³»ç»Ÿè°ƒç”¨ =====
  window.enterStoryboardMode = function (items) {
    const imageRefs = items
      .map((item) => item.localPath || item.remoteUrl)
      .filter(Boolean);
    if (imageRefs.length === 0) return;

    // 1. åˆ‡æ¢åˆ°æ•…äº‹æ¿ Tab
    const storyboardTabBtn = document.querySelector("#storyboard-tab");
    if (storyboardTabBtn) {
      const tab = new bootstrap.Tab(storyboardTabBtn);
      tab.show();
    }

    // 2. ç¡®ä¿å ä½æç¤ºéšè—ï¼ˆå³ä½¿é¦–æ¬¡è¿›å…¥ï¼‰
    //$("#storyboardPlaceholder").removeClass("d-flex").hide();
    $("#storyboardPanels").show();

    // 3. æ·»åŠ æ–°åˆ†é•œ
    addPanel({
      images: imageRefs,
      description: "",
      cameraMovement: "fixed",
      cameraNote: "",
    });
  };

  // ===== ä¿å­˜ =====
  async function saveStoryboard() {
    const data = {
      id: storyboardState.currentId, // å¯èƒ½ä¸º null
      title: storyboardState.title,
      panels: storyboardState.panels.map((p) => ({
        panel_id: p.panel_id,
        images: p.images,
        description: p.description,
        camera_movement: p.cameraMovement,
        camera_note: p.cameraNote,
      })),
    };

    try {
      const resp = await fetch("/save-storyboard", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      const result = await resp.json();
      if (result.success) {
        storyboardState.currentId = result.record_id; // æ–°å»ºæ—¶æ›´æ–° ID
        storyboardState.title = data.title;
        loadStoryboardList(); // åˆ·æ–°ä¸‹æ‹‰èœå•
        showToast("æ•…äº‹æ¿ä¿å­˜æˆåŠŸï¼", "success", 5000);
        window.shouldHighlightNewRecords = true;

        loadStoryboardListIntoDropdown();
        // document.querySelector('button[data-bs-target="#quick-gen"]').click();
      } else {
        throw new Error(result.error || "ä¿å­˜å¤±è´¥");
      }
    } catch (err) {
      console.error(err);
      showToast("ä¿å­˜å¤±è´¥ï¼š" + err.message, "error", 5000);
    }
  }

  async function switchToStoryboard(id) {
    // å¦‚æœå½“å‰æœ‰å†…å®¹ï¼Œæç¤ºä¿å­˜ï¼ˆå¯é€‰ï¼‰
    if (storyboardState.panels.length > 0 && storyboardState.currentId) {
      const shouldSave = confirm("å½“å‰æ•…äº‹æ¿æœ‰ä¿®æ”¹ï¼Œæ˜¯å¦å…ˆä¿å­˜ï¼Ÿ");
      if (shouldSave) {
        await saveStoryboard(); // ä½ å·²æœ‰çš„ä¿å­˜å‡½æ•°
      }
    }

    if (id === "__new__") {
      // æ–°å»º
      storyboardState = {
        currentId: null,
        title: "æœªå‘½åæ•…äº‹æ¿",
        panels: [],
      };
    } else if (id) {
      // åŠ è½½å·²æœ‰
      try {
        const resp = await fetch(`/load-storyboard/${id}`);
        const data = await resp.json();
        storyboardState = {
          currentId: data.id,
          title: data.title || "æœªå‘½åæ•…äº‹æ¿",
          panels: data.panels || [],
        };
      } catch (err) {
        showToast("åŠ è½½å¤±è´¥", "error");
        return;
      }
    } else {
      // é€‰æ‹©â€œâ€”è¯·é€‰æ‹©â€”â€ï¼Œæ¸…ç©º
      storyboardState = { currentId: null, title: "æœªå‘½åæ•…äº‹æ¿", panels: [] };
    }

    renderPanels();
    applyUniformAspectRatio();
    updateSaveButton();
    loadStoryboardListIntoDropdown();
    // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰ä¸­çŠ¶æ€ï¼ˆå·²åœ¨ loadStoryboardList ä¸­å¤„ç†ï¼‰
  }

  $("#storyboardSelector").change(function () {
    const id = $(this).val();
    switchToStoryboard(id);
  });

  //æ–°å»º
  $(document).on(
    "click",
    "#storyboardDropdownMenu [data-action='new']",
    function (e) {
      e.preventDefault();
      storyboardState = { currentId: null, title: "æœªå‘½åæ•…äº‹æ¿", panels: [] };
      renderPanels();
      applyUniformAspectRatio();
      updateSaveButton();
      resetStoryboard(); // æ¸…ç©ºå½“å‰ï¼Œæ–°å»º
      $("#storyboardTitle").text("æœªå‘½åæ•…äº‹æ¿").focus();
    },
  );

  $(document).on(
    "click",
    "#storyboardDropdownMenu .dropdown-item[data-id]",
    function (e) {
      e.preventDefault();
      const id = $(this).data("id");
      switchToStoryboard(id);
    },
  );

  // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
  function startEditingTitle() {
    const text = $("#storyboardTitleText").text();
    $("#storyboardTitleInput").val(text).removeClass("d-none");
    $("#storyboardTitleText").hide();
    $("#editTitleBtn").hide();
    $("#storyboardTitleInput").focus().select(); // å…¨é€‰æ–¹ä¾¿ç¼–è¾‘
  }

  // ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘
  function finishEditingTitle() {
    const newTitle = $("#storyboardTitleInput").val().trim() || "æœªå‘½åæ•…äº‹æ¿";
    $("#storyboardTitleText").text(newTitle);
    $("#storyboardTitleInput").addClass("d-none");
    $("#storyboardTitleText").show();
    $("#editTitleBtn").show();
    storyboardState.title = newTitle;
  }

  // ç»‘å®šäº‹ä»¶
  $("#storyboardTitleText, #editTitleBtn").on("click", startEditingTitle);
  $("#storyboardTitleInput").on("blur", finishEditingTitle);
  $("#storyboardTitleInput").on("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      finishEditingTitle();
    } else if (e.key === "Escape") {
      e.preventDefault();
      $("#storyboardTitleInput").blur();
    }
  });

  // åˆå§‹åŒ–
  init();
  // loadStoryboardList();
  loadStoryboardListIntoDropdown();
})();


